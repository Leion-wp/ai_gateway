(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var n in a)e.o(a,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:a[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.plugins,n=window.wp.editPost,o=window.wp.components,l=window.wp.element,r=window.wp.data,i=window.wp.blocks,c=window.wp.apiFetch;var s=e.n(c);const u=window.wp.blockEditor,p=window.wp.i18n,d=window.AIGatewaySettings||{restUrl:"",nonce:"",agents:[]};d.nonce&&s().use(s().createNonceMiddleware(d.nonce));const g=[{key:"rewrite",label:(0,p.__)("Rewrite","ai-gateway"),instruction:(0,p.__)("Rewrite the text to be clearer and more engaging.","ai-gateway")},{key:"seo",label:(0,p.__)("SEO","ai-gateway"),instruction:(0,p.__)("Optimize the content for SEO while keeping a natural tone.","ai-gateway")},{key:"summarize",label:(0,p.__)("Summarize","ai-gateway"),instruction:(0,p.__)("Summarize the content in a few bullet points.","ai-gateway")},{key:"outline",label:(0,p.__)("Outline","ai-gateway"),instruction:(0,p.__)("Generate a structured outline for this article.","ai-gateway")}],m=e=>String(e||"").replace(/<[^>]+>/g,"").trim(),y=e=>{const t=e.name.replace("core/",""),a=m(e.attributes?.content||e.attributes?.title||"");return a?`${t}: ${a.slice(0,40)}`:t},_=e=>{const t=(0,r.select)("core/block-editor").getSelectedBlock();if(t){const a=(0,r.select)("core/block-editor").getBlockIndex(t.clientId);(0,r.dispatch)("core/block-editor").insertBlocks(e,a+1)}else(0,r.dispatch)("core/block-editor").insertBlocks(e)},h=(e,t)=>(0,i.createBlock)("core/buttons",{},[(0,i.createBlock)("core/button",{text:e,url:t})]);(0,a.registerPlugin)("ai-gateway-plugin",{render:function(){const[e,a]=(0,l.useState)(d.agents||[]),[c,w]=(0,l.useState)(d.agents?.[0]?.id||0),[k,b]=(0,l.useState)(""),[v,B]=(0,l.useState)({}),[f,S]=(0,l.useState)(""),[E,C]=(0,l.useState)(""),[x,T]=(0,l.useState)(!1),[O,P]=(0,l.useState)(!1),[A,I]=(0,l.useState)(""),[M,N]=(0,l.useState)(""),[R,F]=(0,l.useState)(!1),[W,j]=(0,l.useState)(""),q=(0,r.useSelect)(e=>e("core/block-editor").getBlocks(),[]),U=(0,r.useSelect)(e=>e("core/block-editor").getSelectedBlockClientId(),[]),[D,L]=(0,l.useState)(U||""),[Q,G]=(0,l.useState)(""),[J,z]=(0,l.useState)(""),[$,H]=(0,l.useState)(""),[X,K]=(0,l.useState)(""),[V,Y]=(0,l.useState)(""),[Z,ee]=(0,l.useState)("landing"),[te,ae]=(0,l.useState)(""),[ne,oe]=(0,l.useState)("Get Started"),[le,re]=(0,l.useState)("Ready to launch?"),[ie,ce]=(0,l.useState)("Contact"),[se,ue]=(0,l.useState)("#"),[pe,de]=(0,l.useState)(""),[ge,me]=(0,l.useState)(""),[ye,_e]=(0,l.useState)(!1),[he,we]=(0,l.useState)("Hero Title"),[ke,be]=(0,l.useState)("Short supporting copy goes here."),[ve,Be]=(0,l.useState)("Learn more"),[fe,Se]=(0,l.useState)("#"),[Ee,Ce]=(0,l.useState)(null),xe=(0,l.useMemo)(()=>e.find(e=>e.id===c),[e,c]),Te=(0,l.useMemo)(()=>q.find(e=>e.clientId===D),[q,D]),Oe=(xe?.input_schema||[]).map(e=>"string"==typeof e?{key:e,label:e,type:"text"}:e&&e.key?{key:e.key,label:e.label||e.key,type:e.type||"text",options:e.options||[],placeholder:e.placeholder||"",required:Boolean(e.required),env:e.env||""}:null).filter(Boolean).filter(e=>!e.env),Pe=xe?.output_mode||"text",Ae=xe?.tools||["smart_edit","outline_sections","page_template","faq_builder","cta_builder","quick_palette","media_insert","hero_section"],Ie=e=>Ae.includes(e),Me=()=>{const e={};Oe.forEach(t=>{e[t.key]=""}),B(e)};(0,l.useEffect)(()=>{if(e.length)return;let t=!0;return(async()=>{P(!0);try{const e=await s()({path:"/ai/v1/agents?enabled=1",method:"GET"});if(!t)return;const n=Array.isArray(e)?e:[];a(n),w(n[0]?.id||0)}catch(e){t&&I(e.message||"Failed to load agents.")}finally{t&&P(!1)}})(),()=>{t=!1}},[e.length]),(0,l.useEffect)(()=>{Me()},[c]),(0,l.useEffect)(()=>{U&&U!==D&&L(U)},[U,D]),(0,l.useEffect)(()=>{if(!Te)return void G("");const e=Te.attributes?.content||Te.attributes?.title||"";G(m(e))},[Te]);const Ne=(e,t)=>{B(a=>({...a,[e]:t}))},Re=e.map(e=>({label:e.name,value:e.id})),Fe=q.map(e=>({label:y(e),value:e.clientId}));return(0,t.createElement)(n.PluginSidebar,{name:"ai-gateway",title:(0,p.__)("AI Agent","ai-gateway")},(0,t.createElement)(o.PanelBody,{title:(0,p.__)("AI Assistant","ai-gateway")},O&&(0,t.createElement)(o.Spinner,null),A&&(0,t.createElement)(o.Notice,{status:"error",isDismissible:!1},A,M&&(0,t.createElement)("div",{style:{marginTop:"8px"}},(0,t.createElement)("div",null,M),(0,t.createElement)(o.Button,{variant:"secondary",onClick:async()=>{if(M){F(!0),j((0,p.__)("Downloading model...","ai-gateway"));try{const e=await fetch("/wp-json/ai/v1/ollama/pull/stream",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":d.nonce||""},body:JSON.stringify({model:M})}),t=e.headers.get("content-type")||"";if(!e.ok||!e.body||!t.includes("text/event-stream"))throw new Error("Pull stream unavailable");const a=e.body.getReader(),n=new TextDecoder("utf-8");let o="";for(;;){const{value:e,done:t}=await a.read();if(t)break;o+=n.decode(e,{stream:!0});const l=o.split("\n\n");o=l.pop()||"",l.forEach(e=>{e.split("\n").forEach(e=>{if(!e.startsWith("data: "))return;const t=e.slice(6).trim();if(t)try{const e=JSON.parse(t);if(e.error)return void j(e.error);if(e.status&&j(e.status),e.completed&&e.total){const t=Math.round(e.completed/e.total*100);j(`${e.status||"Downloading"} (${t}%)`)}}catch(e){j(e.message||"Pull parse error.")}})})}}catch(e){j(e.message||"Pull failed.")}finally{F(!1)}}},isBusy:R,style:{marginTop:"6px"}},(0,p.__)("Download model","ai-gateway")),W&&(0,t.createElement)("div",{style:{marginTop:"6px"}},W))),(0,t.createElement)(o.SelectControl,{label:(0,p.__)("Agent","ai-gateway"),value:c,options:Re,onChange:e=>w(Number(e))}),(0,t.createElement)(o.TextareaControl,{label:(0,p.__)("Instruction","ai-gateway"),value:k,onChange:b}),(0,t.createElement)("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px",marginBottom:"12px"}},g.map(e=>(0,t.createElement)(o.Button,{key:e.key,variant:"secondary",onClick:()=>(e=>{b(e.instruction),e.inputs&&B(t=>({...t,...e.inputs}))})(e)},e.label))),Oe.map(e=>{if("textarea"===e.type)return(0,t.createElement)(o.TextareaControl,{key:e.key,label:e.label,value:v[e.key]||"",onChange:t=>Ne(e.key,t),help:e.placeholder});if("select"===e.type){const a=Array.isArray(e.options)?e.options:String(e.options||"").split(",").map(e=>e.trim()).filter(Boolean);return(0,t.createElement)(o.SelectControl,{key:e.key,label:e.label,value:v[e.key]||"",options:a.map(e=>({label:e,value:e})),onChange:t=>Ne(e.key,t)})}return(0,t.createElement)(o.TextControl,{key:e.key,label:e.label,value:v[e.key]||"",onChange:t=>Ne(e.key,t),type:"number"===e.type?"number":"url"===e.type?"url":"password"===e.type?"password":"text",help:e.placeholder})}),(0,t.createElement)("div",{style:{display:"flex",gap:"8px",marginTop:"12px"}},(0,t.createElement)(o.Button,{variant:"primary",isBusy:x,onClick:async()=>{if(c){T(!0),I(""),C(""),S((0,p.__)("Running...","ai-gateway"));try{const e=await fetch("/wp-json/ai/v1/run/stream",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":d.nonce||""},body:JSON.stringify({agent_id:c,instruction:k,inputs:v})}),t=e.headers.get("content-type")||"";if(!e.ok||!e.body||!t.includes("text/event-stream"))throw new Error("Stream unavailable");const a=e.body.getReader(),n=new TextDecoder("utf-8");let o="";for(S("");;){const{value:e,done:t}=await a.read();if(t)break;o+=n.decode(e,{stream:!0});const l=o.split("\n\n");o=l.pop()||"",l.forEach(e=>{e.split("\n").forEach(e=>{if(!e.startsWith("data: "))return;const t=e.slice(6).trim();if(t)try{const e=JSON.parse(t);if(e.error)return"model_not_found"===e.error?(N(e.model||""),void I("Model not found.")):void I(e.error);e.delta&&S(t=>t+e.delta),e.mcp_meta&&C(e.mcp_meta),e.done&&e.full&&(S(e.full),e.mcp_response&&C(e.mcp_meta||""))}catch(e){I(e.message||"Stream parse error.")}})})}}catch(e){await(async()=>{const e=await s()({path:"/ai/v1/run",method:"POST",data:{agent_id:c,instruction:k,inputs:v}});if(e?.error){if("model_not_found"===e.error)return N(e.model||""),void I("Model not found.");I(e.error),S("")}else S(e?.mcp_response||e?.ollama_response||""),C(e?.mcp_meta||"")})()}finally{T(!1)}}else I("No agent selected.")}},(0,p.__)("Generate","ai-gateway")),(0,t.createElement)(o.Button,{variant:"secondary",onClick:()=>{if(!f)return;if("blocks"===Pe){try{const e=JSON.parse(f),t=(e=>{const t=e=>{if(!e||!e.name)return null;const a=(e.innerBlocks||[]).map(t).filter(Boolean);return(0,i.createBlock)(e.name,e.attributes||{},a)};return e.map(t).filter(Boolean)})(Array.isArray(e)?e:e.blocks||[]);t.length&&_(t)}catch(e){I(e.message||"Failed to parse blocks.")}return}const e=(0,r.select)("core/block-editor").getSelectedBlock();e&&Object.prototype.hasOwnProperty.call(e.attributes,"content")?(0,r.dispatch)("core/block-editor").updateBlockAttributes(e.clientId,{content:f}):_([(0,i.createBlock)("core/paragraph",{content:f})])}},(0,p.__)("Insert","ai-gateway")),(0,t.createElement)(o.Button,{variant:"tertiary",onClick:Me},(0,p.__)("Reset","ai-gateway"))),(0,t.createElement)(o.TextareaControl,{label:(0,p.__)("Result","ai-gateway"),value:f,onChange:S,help:E})),Ie("smart_edit")&&(0,t.createElement)(o.PanelBody,{title:(0,p.__)("Smart Edit","ai-gateway"),initialOpen:!1},X&&(0,t.createElement)(o.Notice,{status:"error",isDismissible:!1},X),(0,t.createElement)(o.SelectControl,{label:(0,p.__)("Target block","ai-gateway"),value:D,options:Fe,onChange:e=>L(e)}),(0,t.createElement)(o.TextareaControl,{label:(0,p.__)("Block text","ai-gateway"),value:Q,onChange:G}),(0,t.createElement)(o.TextControl,{label:(0,p.__)("Text color (hex)","ai-gateway"),value:J,onChange:z}),(0,t.createElement)(o.TextControl,{label:(0,p.__)("Background color (hex)","ai-gateway"),value:$,onChange:H}),(0,t.createElement)(o.Button,{variant:"primary",onClick:()=>{if(!Te)return void K("Select a block first.");const e={...Te.attributes};if(Object.prototype.hasOwnProperty.call(e,"content"))e.content=Q;else{if(!Object.prototype.hasOwnProperty.call(e,"title"))return void K("Selected block has no editable text.");e.title=Q}const t={...e.style||{}};J&&(t.color={...t.color||{},text:J}),$&&(t.color={...t.color||{},background:$}),(J||$)&&(e.style=t),(0,r.dispatch)("core/block-editor").updateBlockAttributes(Te.clientId,e),K("")}},(0,p.__)("Apply changes","ai-gateway"))),Ie("outline_sections")&&(0,t.createElement)(o.PanelBody,{title:(0,p.__)("Outline to Sections","ai-gateway"),initialOpen:!1},(0,t.createElement)(o.TextareaControl,{label:(0,p.__)("Outline (one per line)","ai-gateway"),value:V,onChange:Y}),(0,t.createElement)(o.Button,{variant:"primary",onClick:()=>{const e=V.split("\n").map(e=>e.trim()).filter(Boolean);if(!e.length)return;const t=[];e.forEach(e=>{let a=2,n=e;e.startsWith("### ")?(a=3,n=e.slice(4)):e.startsWith("## ")?(a=2,n=e.slice(3)):e.startsWith("# ")&&(a=2,n=e.slice(2)),t.push((0,i.createBlock)("core/heading",{level:a,content:n})),t.push((0,i.createBlock)("core/paragraph",{content:""}))}),_(t)}},(0,p.__)("Insert sections","ai-gateway"))),Ie("page_template")&&(0,t.createElement)(o.PanelBody,{title:(0,p.__)("Page Template","ai-gateway"),initialOpen:!1},(0,t.createElement)(o.SelectControl,{label:(0,p.__)("Template","ai-gateway"),value:Z,options:[{label:"Landing",value:"landing"},{label:"Blog",value:"blog"},{label:"Service",value:"service"}],onChange:ee}),(0,t.createElement)(o.Button,{variant:"primary",onClick:()=>{var e;_("landing"===(e=Z)?[(0,i.createBlock)("core/heading",{level:1,content:"Landing Page Title"}),(0,i.createBlock)("core/paragraph",{content:"Short value proposition goes here."}),(0,i.createBlock)("core/columns",{},[(0,i.createBlock)("core/column",{},[(0,i.createBlock)("core/heading",{level:3,content:"Feature One"}),(0,i.createBlock)("core/paragraph",{content:"Feature description."})]),(0,i.createBlock)("core/column",{},[(0,i.createBlock)("core/heading",{level:3,content:"Feature Two"}),(0,i.createBlock)("core/paragraph",{content:"Feature description."})])]),h("Get Started","#")]:"blog"===e?[(0,i.createBlock)("core/heading",{level:1,content:"Blog Post Title"}),(0,i.createBlock)("core/paragraph",{content:"Intro paragraph."}),(0,i.createBlock)("core/heading",{level:2,content:"Section One"}),(0,i.createBlock)("core/paragraph",{content:"Section content."}),(0,i.createBlock)("core/heading",{level:2,content:"Section Two"}),(0,i.createBlock)("core/paragraph",{content:"Section content."})]:[(0,i.createBlock)("core/heading",{level:1,content:"Service Page"}),(0,i.createBlock)("core/paragraph",{content:"Service overview."}),(0,i.createBlock)("core/heading",{level:2,content:"Benefits"}),(0,i.createBlock)("core/list",{values:"<li>Benefit one</li><li>Benefit two</li>"}),h("Contact Us","#")])}},(0,p.__)("Insert template","ai-gateway"))),Ie("faq_builder")&&(0,t.createElement)(o.PanelBody,{title:(0,p.__)("FAQ Builder","ai-gateway"),initialOpen:!1},(0,t.createElement)(o.TextareaControl,{label:(0,p.__)("FAQ input (Q:/A:)","ai-gateway"),value:te,onChange:ae}),(0,t.createElement)(o.Button,{variant:"primary",onClick:()=>{const e=te.split("\n").map(e=>e.trim()).filter(Boolean),t=[];let a=null;if(e.forEach(e=>{if(e.toLowerCase().startsWith("q:"))return a={q:e.slice(2).trim(),a:""},void t.push(a);e.toLowerCase().startsWith("a:")?a&&(a.a=e.slice(2).trim()):a&&!a.a&&(a.a=e)}),!t.length)return;const n=[(0,i.createBlock)("core/heading",{level:2,content:"FAQ"})];t.forEach(e=>{n.push((0,i.createBlock)("core/heading",{level:3,content:e.q||"Question"})),n.push((0,i.createBlock)("core/paragraph",{content:e.a||""}))}),_(n)}},(0,p.__)("Insert FAQ","ai-gateway"))),Ie("cta_builder")&&(0,t.createElement)(o.PanelBody,{title:(0,p.__)("CTA Builder","ai-gateway"),initialOpen:!1},(0,t.createElement)(o.TextControl,{label:(0,p.__)("Title","ai-gateway"),value:ne,onChange:oe}),(0,t.createElement)(o.TextareaControl,{label:(0,p.__)("Body","ai-gateway"),value:le,onChange:re}),(0,t.createElement)(o.TextControl,{label:(0,p.__)("Button text","ai-gateway"),value:ie,onChange:ce}),(0,t.createElement)(o.TextControl,{label:(0,p.__)("Button URL","ai-gateway"),value:se,onChange:ue}),(0,t.createElement)(o.Button,{variant:"primary",onClick:()=>{const e=[(0,i.createBlock)("core/group",{},[(0,i.createBlock)("core/heading",{level:2,content:ne}),(0,i.createBlock)("core/paragraph",{content:le}),h(ie,se)])];_(e)}},(0,p.__)("Insert CTA","ai-gateway"))),Ie("quick_palette")&&(0,t.createElement)(o.PanelBody,{title:(0,p.__)("Quick Palette","ai-gateway"),initialOpen:!1},(0,t.createElement)(o.TextControl,{label:(0,p.__)("Text color (hex)","ai-gateway"),value:pe,onChange:de}),(0,t.createElement)(o.TextControl,{label:(0,p.__)("Background color (hex)","ai-gateway"),value:ge,onChange:me}),(0,t.createElement)(o.ToggleControl,{label:(0,p.__)("Apply to all blocks","ai-gateway"),checked:ye,onChange:_e}),(0,t.createElement)(o.Button,{variant:"primary",onClick:()=>{const e=ye?q:Te?[Te]:[];e.length&&e.forEach(e=>{const t={...e.attributes},a={...t.style||{}};pe&&(a.color={...a.color||{},text:pe}),ge&&(a.color={...a.color||{},background:ge}),t.style=a,(0,r.dispatch)("core/block-editor").updateBlockAttributes(e.clientId,t)})}},(0,p.__)("Apply palette","ai-gateway"))),Ie("media_insert")&&(0,t.createElement)(o.PanelBody,{title:(0,p.__)("Media Smart Insert","ai-gateway"),initialOpen:!1},(0,t.createElement)(u.MediaUploadCheck,null,(0,t.createElement)(u.MediaUpload,{onSelect:e=>{if(!e||!e.url)return;const t=(0,i.createBlock)("core/image",{id:e.id,url:e.url,alt:e.alt||""});_([t])},allowedTypes:["image"],render:({open:e})=>(0,t.createElement)(o.Button,{variant:"secondary",onClick:e},(0,p.__)("Select image","ai-gateway"))}))),Ie("hero_section")&&(0,t.createElement)(o.PanelBody,{title:(0,p.__)("Hero Section","ai-gateway"),initialOpen:!1},(0,t.createElement)(o.TextControl,{label:(0,p.__)("Title","ai-gateway"),value:he,onChange:we}),(0,t.createElement)(o.TextareaControl,{label:(0,p.__)("Subtitle","ai-gateway"),value:ke,onChange:be}),(0,t.createElement)(o.TextControl,{label:(0,p.__)("Button text","ai-gateway"),value:ve,onChange:Be}),(0,t.createElement)(o.TextControl,{label:(0,p.__)("Button URL","ai-gateway"),value:fe,onChange:Se}),(0,t.createElement)(u.MediaUploadCheck,null,(0,t.createElement)(u.MediaUpload,{onSelect:Ce,allowedTypes:["image"],render:({open:e})=>(0,t.createElement)(o.Button,{variant:"secondary",onClick:e},Ee?.url?(0,p.__)("Change image","ai-gateway"):(0,p.__)("Select image","ai-gateway"))})),(0,t.createElement)(o.Button,{variant:"primary",onClick:()=>{const e={url:Ee?.url||void 0,dimRatio:30},t=[(0,i.createBlock)("core/heading",{level:1,content:he}),(0,i.createBlock)("core/paragraph",{content:ke}),h(ve,fe)],a=(0,i.createBlock)("core/cover",e,t);_([a])}},(0,p.__)("Insert hero","ai-gateway"))))}})})();