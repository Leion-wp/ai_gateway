(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var i in a)e.o(a,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:a[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.blocks,i=window.wp.blockEditor,n=window.wp.apiFetch;var s=e.n(n);const o=window.wp.i18n,l=window.wp.element,c=window.AIGatewaySettings||{restUrl:"",nonce:"",agents:[]};c.nonce&&s().use(s().createNonceMiddleware(c.nonce));const r=[{match:/seo|keywords|rank\s*math|yoast/i,tools:["SEO"]},{match:/rewrite|rephrase|improve|ameliore|améliore|reformule/i,tools:["Rewrite"]},{match:/outline|plan|structure/i,tools:["Outline"]},{match:/summary|summarize|resume|résume/i,tools:["Summarize"]},{match:/ui|design|layout|dark\s*mode/i,tools:["UI Changer","UI Builder"]},{match:/faq/i,tools:["FAQ Builder"]},{match:/cta|call to action/i,tools:["CTA Builder"]}],d=()=>`node_${Date.now()}_${Math.floor(1e3*Math.random())}`,u=e=>(Array.isArray(e)?e:[]).map((e,t)=>{const a=40+40*t,i=40+100*t;return{id:e.id||d(),type:e.type||"run_agent",x:Number.isFinite(e.x)?e.x:a,y:Number.isFinite(e.y)?e.y:i,...e}});function m(){const[e,a]=(0,l.useState)(c.agents||[]),[i,n]=(0,l.useState)(c.studioDefaultAgent||c.agents?.[0]?.id||0),[m,p]=(0,l.useState)(""),[w,g]=(0,l.useState)({}),[y,v]=(0,l.useState)([]),[h,_]=(0,l.useState)([]),[E,f]=(0,l.useState)(0),[b,N]=(0,l.useState)([]),[k,S]=(0,l.useState)(0),[C,$]=(0,l.useState)(!1),[P,T]=(0,l.useState)(""),[A,D]=(0,l.useState)(!1),[I,x]=(0,l.useState)(window.localStorage.getItem("ai_gateway_workspace_mode")||"chat"),[O,j]=(0,l.useState)(null),[U,M]=(0,l.useState)(0),[F,R]=(0,l.useState)(""),[L,W]=(0,l.useState)(!1),[B,G]=(0,l.useState)(Number(window.localStorage.getItem("ai_gateway_workspace_width"))||360),[q,X]=(0,l.useState)(!1),[z,V]=(0,l.useState)([]),[Y,J]=(0,l.useState)(""),[Q,H]=(0,l.useState)(""),[K,Z]=(0,l.useState)(null),[ee,te]=(0,l.useState)([]),[ae,ie]=(0,l.useState)(!1),[ne,se]=(0,l.useState)(!1),[oe,le]=(0,l.useState)(!1),[ce,re]=(0,l.useState)(!1),[de,ue]=(0,l.useState)(""),[me,pe]=(0,l.useState)("article"),[we,ge]=(0,l.useState)(""),[ye,ve]=(0,l.useState)(""),[he,_e]=(0,l.useState)(""),[Ee,fe]=(0,l.useState)("append"),[be,Ne]=(0,l.useState)("article"),[ke,Se]=(0,l.useState)(""),[Ce,$e]=(0,l.useState)(!0),[Pe,Te]=(0,l.useState)(""),[Ae,De]=(0,l.useState)([]),[Ie,xe]=(0,l.useState)([]),[Oe,je]=(0,l.useState)([]),[Ue,Me]=(0,l.useState)(""),[Fe,Re]=(0,l.useState)([]),[Le,We]=(0,l.useState)(""),[Be,Ge]=(0,l.useState)(!1),[qe,Xe]=(0,l.useState)("article"),[ze,Ve]=(0,l.useState)(""),[Ye,Je]=(0,l.useState)(""),[Qe,He]=(0,l.useState)([]),[Ke,Ze]=(0,l.useState)(0),[et,tt]=(0,l.useState)(""),[at,it]=(0,l.useState)([]),[nt,st]=(0,l.useState)(""),[ot,lt]=(0,l.useState)([]),[ct,rt]=(0,l.useState)(""),[dt,ut]=(0,l.useState)(null),mt=(0,l.useRef)([]),pt=async(e,t,a)=>{if(e)try{await s()({path:`/ai/v1/conversations/${e}/messages`,method:"POST",data:{role:t,content:a}})}catch(e){wt(e.message||"Failed to save message.")}},wt=e=>{T(e),He(t=>[{message:e,time:(new Date).toISOString()},...t.slice(0,9)])},gt=(0,l.useMemo)(()=>e.find(e=>e.id===i),[e,i]),yt=(e=>(e||[]).map(e=>"string"==typeof e?{key:e,label:e,type:"text"}:e&&e.key?{key:e.key,label:e.label||e.key,type:e.type||"text",options:e.options||[],placeholder:e.placeholder||"",required:Boolean(e.required),env:e.env||""}:null).filter(Boolean))(gt?.input_schema||[]).filter(e=>!e.env),vt=c.adminUrl||"/wp-admin/",ht=gt?.tools||[],_t=(0,l.useMemo)(()=>{const t={};return e.forEach(e=>{t[e.id]=e}),t},[e]),Et=()=>{const e={};yt.forEach(t=>{e[t.key]=""}),g(e)},ft=e=>{const t=e||"",a=r.filter(e=>e.match.test(t)).flatMap(e=>e.tools),i=/page|landing|homepage|accueil/i.test(t)?"page":"article";return{intent:/publish|post|article|page|create|ecrire|écrire/i.test(t)?"create":"chat",createType:i,tools:[...new Set(a)]}},bt=e=>{if(!e?.tools?.length)return z;const t=ht.length?ht:[],a=[...new Set([...z,...e.tools])],i=t.length?a.filter(e=>t.includes(e)):a;if(V(i),e.tools.some(e=>/seo/i.test(e))){const e=Ae.filter(e=>e.active&&/yoast|rank\s*math/i.test(e.name)).map(e=>e.tool);e.length&&xe(t=>[...new Set([...t,...e])])}return i},Nt=()=>{const e=b.find(e=>e.id===k);return e?.name||"Draft"},kt=()=>{const e=[...y].reverse().find(e=>"assistant"===e.role);if(e?.content)return e.content;const t=[...y].reverse().find(e=>"user"===e.role);return t?.content?t.content:m||""},St=async(e,t,a)=>{const i="page"===e?"/wp/v2/pages":"/wp/v2/posts",n=await s()({path:i,method:"POST",data:{title:t||"Draft",content:a,status:"draft"}});if(Ze(n?.id||0),n?.id){const a=`${t||"Draft"} (ID: ${n.id})`;await s()({path:`${i}/${n.id}`,method:"POST",data:{title:a}}),tt("page"===e?`${window.location.origin}/?page_id=${n.id}&preview=true`:`${window.location.origin}/?p=${n.id}&preview=true`)}return n},Ct=async(e,t,a,i,n,o)=>{if(!t)throw new Error("Post ID required.");const l="page"===e?`/wp/v2/pages/${t}`:`/wp/v2/posts/${t}`,c={content:i};return a&&(c.title=a),n&&(c.status=n),o&&(c.date=o),s()({path:l,method:"POST",data:c})},$t=async()=>{const e=await s()({path:"/ai/v1/plugins",method:"GET"}),t=Array.isArray(e)?e:[];je(t);const a=t.map(e=>({name:e.name,active:Boolean(e.active)})).filter(e=>/yoast|rank\s*math|ewww/i.test(e.name||"")).map(e=>({...e,tool:e.name}));De(a)};(0,l.useEffect)(()=>{if(e.length)return;let t=!0;return(async()=>{try{const e=await s()({path:"/ai/v1/agents?enabled=1",method:"GET"});if(!t)return;const i=Array.isArray(e)?e:[];a(i);const o=c.studioDefaultAgent||0,l=i.find(e=>e.id===o);n(l?.id||i[0]?.id||0)}catch(e){t&&wt(e.message||"Failed to load agents.")}})(),()=>{t=!1}},[e.length]),(0,l.useEffect)(()=>{let e=!0;return(async()=>{try{const t=await s()({path:"/ai/v1/plugins",method:"GET"});if(!e)return;const a=Array.isArray(t)?t:[];je(a);const i=a.map(e=>({name:e.name,active:Boolean(e.active)})).filter(e=>/yoast|rank\s*math|ewww/i.test(e.name||"")).map(e=>({...e,tool:e.name}));De(i)}catch(e){wt(e.message||"Failed to load plugins.")}})(),()=>{e=!1}},[]),(0,l.useEffect)(()=>{Et(),V(gt?.tools||[])},[i]),(0,l.useEffect)(()=>{if(!q)return;const e=e=>{const t=Math.min(640,Math.max(260,window.innerWidth-e.clientX-24));G(t)},t=()=>{X(!1)};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[q]),(0,l.useEffect)(()=>{if(!dt)return;const e=e=>{const t=document.querySelector(".ai-studio-workflow-canvas");if(!t)return;const a=t.getBoundingClientRect(),i=e.clientX-a.left-dt.offsetX,n=e.clientY-a.top-dt.offsetY;it(e=>e.map(e=>e.id===dt.id?{...e,x:Math.max(20,i),y:Math.max(20,n)}:e))},t=()=>{ut(null),At(mt.current)};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[dt]),(0,l.useEffect)(()=>{window.localStorage.setItem("ai_gateway_workspace_mode",I)},[I]),(0,l.useEffect)(()=>{window.localStorage.setItem("ai_gateway_workspace_width",String(B))},[B]),(0,l.useEffect)(()=>{let e=!0;return(async()=>{try{const t=await s()({path:"/ai/v1/projects",method:"GET"}),a=Array.isArray(t)?t:[];if(!e)return;if(!a.length){const e=await s()({path:"/ai/v1/projects",method:"POST",data:{name:"General"}});return _([e]),void f(e.id)}_(a),f(a[0]?.id||0)}catch(t){e&&wt(t.message||"Failed to load projects.")}})(),()=>{e=!1}},[]),(0,l.useEffect)(()=>{if(!E)return;let e=!0;return(async()=>{try{const t=await s()({path:`/ai/v1/conversations?project_id=${E}&include_archived=${ne?"1":"0"}`,method:"GET"});if(!e)return;const a=Array.isArray(t)?t:[];N(a),S(a[0]?.id||0)}catch(t){e&&wt(t.message||"Failed to load conversations.")}})(),()=>{e=!1}},[E,ne]),(0,l.useEffect)(()=>{if(!k)return void v([]);let e=!0;return(async()=>{try{const t=await s()({path:`/ai/v1/conversations/${k}`,method:"GET"});e&&t?.messages&&v(t.messages)}catch(t){e&&wt(t.message||"Failed to load conversation.")}})(),()=>{e=!1}},[k]),(0,l.useEffect)(()=>{if(!k)return void it([]);let e=!0;return(async()=>{try{const t=await s()({path:`/ai/v1/conversations/${k}/workflow`,method:"GET"});e&&(it(u(t?.workflow)),lt(Array.isArray(t?.versions)?t.versions:[]))}catch(e){wt(e.message||"Failed to load workflow.")}})(),()=>{e=!1}},[k]),(0,l.useEffect)(()=>{mt.current=at},[at]);const Pt=(e,t)=>{v(a=>{if(!a.length)return a;const i=[...a],n=i[i.length-1];return"assistant"!==n.role?a:(i[i.length-1]={...n,content:t?e:n.content+e},i)})},Tt=async()=>{$(!0),le(!0),T("");let e=z;if(Ce&&m){const t=ft(m);Te(t.tools.length?t.tools.join(", "):""),Ne(t.createType),e=bt(t)}const t=Ie.length?`\n\nPlugins: ${Ie.join(", ")}`:"",a=e.length?`${m}\n\nTools: ${e.join(", ")}${t}`:`${m}${t}`;let i=k;if(!i){const e=await s()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});i=e.id,N(t=>[e,...t]),S(e.id)}v(e=>[...e,{role:"user",content:m}]),pt(i,"user",a);try{for(const e of ee){const t=await s()({path:"/ai/v1/run",method:"POST",data:{agent_id:e,instruction:a,inputs:w}}),n=t?.mcp_response||t?.ollama_response||t?.error||"",o=`${_t[e]?.name||"Agent"}: ${n}`;v(e=>[...e,{role:"assistant",content:o}]),pt(i,"assistant",o)}}catch(e){wt(e.message||"Chain failed.")}finally{$(!1),le(!1),p("")}},At=async(e,t={})=>{if(!k)return;const a={workflow:e};t.saveVersion&&(a.save_version=!0,a.note=t.note||"");const i=await s()({path:`/ai/v1/conversations/${k}/workflow`,method:"POST",data:a});i?.versions&&lt(i.versions)};(0,l.useEffect)(()=>{if(!k||0===y.length)return;const e=setTimeout(async()=>{try{await s()({path:`/ai/v1/conversations/${k}/draft`,method:"POST",data:{messages:y}})}catch(e){wt(e.message||"Failed to save draft.")}},1200);return()=>clearTimeout(e)},[k,y]);const Dt=(0,l.useMemo)(()=>{const e=at.reduce((e,t)=>Math.max(e,t.x||0),0),t=at.reduce((e,t)=>Math.max(e,t.y||0),0);return{width:Math.max(520,e+240+80),height:Math.max(360,t+140+80)}},[at]),It=e=>{const t=at.length,a=[...at,{id:d(),x:40+40*t,y:40+100*t,...e}];it(a),At(a)},xt=(e,t)=>{const a=[...at],i=e+t;if(i<0||i>=a.length)return;const[n]=a.splice(e,1);a.splice(i,0,n),it(a),At(a)};return(0,t.createElement)("div",{className:"ai-studio-app",style:{gridTemplateColumns:`280px 1fr ${B}px`}},(0,t.createElement)("aside",{className:"ai-studio-sidebar"},(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Projects","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-project-row"},(0,t.createElement)("select",{className:"ai-studio-select",value:E,onChange:e=>f(Number(e.target.value))},h.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name))),(0,t.createElement)("button",{type:"button",className:"ai-studio-icon-button",onClick:()=>{re(!0);const e=h.find(e=>e.id===E);ue(e?.name||"")}},"..."))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Conversations","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:ne,onChange:e=>se(e.target.checked)}),(0,o.__)("Show archived","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-conversation-list"},b.map(e=>(0,t.createElement)("div",{key:e.id,className:"ai-studio-conversation-row"},(0,t.createElement)("button",{type:"button",className:"ai-studio-conversation "+(e.id===k?"active":""),onClick:()=>S(e.id)},(0,t.createElement)("div",{className:"ai-studio-conversation-title"},e.name),e.archived&&(0,t.createElement)("div",{className:"ai-studio-conversation-last"},(0,o.__)("Archived","ai-gateway")),e.last&&(0,t.createElement)("div",{className:"ai-studio-conversation-last"},e.last)),(0,t.createElement)("button",{type:"button",className:"ai-studio-icon-button",onClick:()=>{j(e.id),M(0),R("")}},"...")))),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:async()=>{const e=await s()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});N(t=>[e,...t]),S(e.id)}},(0,o.__)("New chat","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Agents","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:i,onChange:e=>n(Number(e.target.value))},e.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Tools","ai-gateway")),0===ht.length&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},(0,o.__)("Assigned via agent.","ai-gateway")),ht.map(e=>(0,t.createElement)("label",{key:e,className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:z.includes(e),onChange:t=>{const a=t.target.checked;V(t=>a?[...t,e]:t.filter(t=>t!==e))}}),e))),Ae.length>0&&(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Plugin tools","ai-gateway")),Ae.map(e=>(0,t.createElement)("label",{key:e.tool,className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:Ie.includes(e.tool),disabled:!e.active,onChange:t=>{const a=t.target.checked;xe(t=>a?[...t,e.tool]:t.filter(t=>t!==e.tool))}}),e.name," ",e.active?"":(0,o.__)("(inactive)","ai-gateway")))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Settings","ai-gateway")),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:()=>D(!0)},(0,o.__)("Open settings","ai-gateway")),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:()=>x("agents")},(0,o.__)("Agents editor","ai-gateway")),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:()=>x("admin")},(0,o.__)("WP Admin","ai-gateway")))),(0,t.createElement)("main",{className:"ai-studio-main"},(0,t.createElement)("div",{className:"ai-studio-topbar"},(0,t.createElement)("div",{className:"ai-studio-topbar-left"},(0,t.createElement)("span",{className:"ai-studio-topbar-label"},(0,o.__)("Active agent","ai-gateway")),(0,t.createElement)("span",{className:"ai-studio-topbar-value"},gt?.name||(0,o.__)("None","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-topbar-right"},(0,t.createElement)("span",{className:"ai-studio-status-dot"}),(0,t.createElement)("span",null,(0,o.__)("Ollama: online","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-tabs"},[{id:"chat",label:(0,o.__)("Chat","ai-gateway")},{id:"editor",label:(0,o.__)("Editor","ai-gateway")},{id:"split",label:(0,o.__)("Split","ai-gateway")},{id:"workflow",label:(0,o.__)("Workflow","ai-gateway")},{id:"preview",label:(0,o.__)("Preview","ai-gateway")},{id:"agents",label:(0,o.__)("Agents","ai-gateway")},{id:"admin",label:(0,o.__)("WP Admin","ai-gateway")}].map(e=>(0,t.createElement)("button",{key:e.id,className:"ai-studio-tab "+(I===e.id?"active":""),onClick:()=>x(e.id)},e.label))))),(0,t.createElement)("div",{className:"ai-studio-chat"},y.map((e,a)=>(0,t.createElement)("div",{key:a,className:`ai-studio-message ai-studio-${e.role}`},(0,t.createElement)("div",{className:"ai-studio-message-role"},e.role),(0,t.createElement)("div",{className:"ai-studio-message-content"},e.content))),oe&&(0,t.createElement)("div",{className:"ai-studio-typing"},gt?.name||(0,o.__)("Agent","ai-gateway")," ",(0,o.__)("is typing...","ai-gateway"))),Qe.length>0&&(0,t.createElement)("div",{className:"ai-studio-error-log"},(0,t.createElement)("strong",null,(0,o.__)("Errors","ai-gateway")),Qe.map((e,a)=>(0,t.createElement)("div",{key:a,className:"ai-studio-error-item"},e.message))),yt.length>0&&(0,t.createElement)("div",{className:"ai-studio-inputs"},yt.map(e=>(0,t.createElement)("label",{key:e.key,className:"ai-studio-field"},(0,t.createElement)("span",null,e.label),(0,t.createElement)("input",{type:"number"===e.type?"number":"url"===e.type?"url":"text",value:w[e.key]||"",placeholder:e.placeholder,onChange:t=>g(a=>({...a,[e.key]:t.target.value}))})))),(0,t.createElement)("div",{className:"ai-studio-composer"},P&&(0,t.createElement)("div",{className:"ai-studio-error"},P),(0,t.createElement)("div",{className:"ai-studio-composer-row"},(0,t.createElement)("button",{className:"ai-studio-button icon",type:"button",title:(0,o.__)("Add","ai-gateway"),onClick:()=>W(e=>!e)},"+"),L&&(0,t.createElement)("div",{className:"ai-studio-plus-menu"},(0,t.createElement)("button",{type:"button",onClick:()=>{W(!1),x("tools")}},(0,o.__)("Tools","ai-gateway")),(0,t.createElement)("button",{type:"button",onClick:()=>{W(!1),x("upload")}},(0,o.__)("Upload image","ai-gateway")),(0,t.createElement)("button",{type:"button",onClick:()=>{W(!1),x("chain")}},(0,o.__)("Chain agents","ai-gateway"))),(0,t.createElement)("textarea",{className:"ai-studio-textarea",rows:"3",placeholder:(0,o.__)("Ask something...","ai-gateway"),value:m,onChange:e=>p(e.target.value)}),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{if(!i)return void wt("No agent selected.");if(ae&&ee.length>0)return void await Tt();$(!0),le(!0),T("");let e=z;if(Ce&&m){const t=ft(m);Te(t.tools.length?t.tools.join(", "):""),Ne(t.createType),e=bt(t)}const t=Ie.length?`\n\nPlugins: ${Ie.join(", ")}`:"",a=e.length?`${m}\n\nTools: ${e.join(", ")}${t}`:`${m}${t}`;let n=k;if(!n){const e=await s()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});n=e.id,N(t=>[e,...t]),S(e.id)}const o={role:"user",content:m};v(e=>[...e,o,{role:"assistant",content:""}]),pt(n,"user",a);try{const e=`${c.restUrl?c.restUrl.replace(/\/$/,""):"/wp-json/ai/v1"}/run/stream`,t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":c.nonce||""},body:JSON.stringify({agent_id:i,instruction:a,inputs:w})}),s=t.headers.get("content-type")||"";if(!t.ok||!t.body||!s.includes("text/event-stream"))throw new Error("Stream unavailable");const o=t.body.getReader(),l=new TextDecoder("utf-8");let r="";for(;;){const{value:e,done:t}=await o.read();if(t)break;r+=l.decode(e,{stream:!0});const a=r.split("\n\n");r=a.pop()||"",a.forEach(e=>{e.split("\n").forEach(e=>{if(!e.startsWith("data: "))return;const t=e.slice(6).trim();if(t)try{const e=JSON.parse(t);if(e.error)return void wt(e.error);e.delta&&Pt(e.delta,!1),e.done&&e.full&&(Pt(e.full,!0),pt(n,"assistant",e.full),le(!1))}catch(e){wt(e.message||"Stream parse error.")}})})}}catch(e){try{const e=await s()({path:"/ai/v1/run",method:"POST",data:{agent_id:i,instruction:a,inputs:w}});if(e?.error)wt(e.error);else{const t=e?.mcp_response||e?.ollama_response||"";Pt(t,!0),pt(n,"assistant",t)}}catch(t){wt(t.message||e.message||"Stream failed.")}}finally{$(!1),p(""),le(!1)}},disabled:C},C?(0,o.__)("Running...","ai-gateway"):(0,o.__)("Send","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:Et},(0,o.__)("Reset","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:ae,onChange:e=>ie(e.target.checked)}),(0,o.__)("Use chain","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:Ce,onChange:e=>$e(e.target.checked)}),(0,o.__)("Auto intent","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-chat-tools"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Chat tools","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-chat-tools-row"},(0,t.createElement)("select",{className:"ai-studio-select",value:Ee,onChange:e=>fe(e.target.value)},(0,t.createElement)("option",{value:"append"},(0,o.__)("Append to editor","ai-gateway")),(0,t.createElement)("option",{value:"replace"},(0,o.__)("Replace editor","ai-gateway")),(0,t.createElement)("option",{value:"section"},(0,o.__)("Add as section","ai-gateway"))),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{const e=kt();if(!e)return void wt("No chat content to inject.");const t=we||Nt();let a="";a="replace"===Ee?e:"section"===Ee?ye?`${ye}\n\n## ${t}\n\n${e}`:`## ${t}\n\n${e}`:ye?`${ye}\n\n${e}`:e,ge(t),ve(a),x("editor"),Se("Injected into editor.")}},(0,o.__)("Inject into editor","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-chat-tools-row"},(0,t.createElement)("select",{className:"ai-studio-select",value:be,onChange:e=>Ne(e.target.value)},(0,t.createElement)("option",{value:"article"},(0,o.__)("Create article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Create page","ai-gateway"))),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{const e=kt();if(!e)return void wt("No chat content to create draft.");if(!window.confirm("Create a draft from the latest chat content?"))return;const t=we||Nt();Se(""),_e(""),x("editor"),pe(be),ge(t),ve(e);try{const a=await St(be,t,e);_e(`Draft created: #${a.id}`),Se(`Draft created: #${a.id}`)}catch(e){const t=e.message||"Failed to create draft.";_e(t),Se(t)}}},(0,o.__)("Create from chat","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-chat-tools-row"},(0,t.createElement)("select",{className:"ai-studio-select",value:qe,onChange:e=>Xe(e.target.value)},(0,t.createElement)("option",{value:"article"},(0,o.__)("Update article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Update page","ai-gateway"))),(0,t.createElement)("input",{className:"ai-studio-input",value:ze,onChange:e=>Ve(e.target.value),placeholder:(0,o.__)("Post ID","ai-gateway")}),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{const e=kt();if(e)if(ze){if(window.confirm(`Update post #${ze} from chat content?`)){Se("");try{await Ct(qe,Number(ze),we,e),Se(`Post updated: #${ze}`),tt("page"===qe?`${window.location.origin}/?page_id=${ze}&preview=true`:`${window.location.origin}/?p=${ze}&preview=true`)}catch(e){Se(e.message||"Failed to update post.")}}}else wt("Post ID is required.");else wt("No chat content to update post.")}},(0,o.__)("Update from chat","ai-gateway"))),Pe&&Ce&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},(0,o.__)("Intent tools:","ai-gateway")," ",Pe),ke&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},ke)))),(0,t.createElement)("aside",{className:"ai-studio-workspace"},(0,t.createElement)("div",{className:"ai-studio-resizer",onMouseDown:()=>X(!0),title:(0,o.__)("Resize","ai-gateway")}),"agents"===I?(0,t.createElement)("iframe",{title:"Agents",className:"ai-studio-iframe",src:`${vt}admin.php?page=ai-gateway-agents&action=edit&agent_id=${i}&studio=1`}):"admin"===I?(0,t.createElement)("iframe",{title:"WP Admin",className:"ai-studio-iframe",src:`${vt}admin.php`}):"tools"===I?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("h3",null,(0,o.__)("Plugin manager","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Search wp.org","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-chat-tools-row"},(0,t.createElement)("input",{className:"ai-studio-input",value:Ue,onChange:e=>Me(e.target.value),placeholder:(0,o.__)("Plugin name or keyword","ai-gateway")}),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{if(Ue.trim()){Ge(!0),We("");try{const e=await s()({path:`/ai/v1/plugins/search?query=${encodeURIComponent(Ue.trim())}`,method:"GET"});Re(Array.isArray(e)?e:[])}catch(e){We(e.message||"Plugin search failed.")}finally{Ge(!1)}}else Re([])},disabled:Be},(0,o.__)("Search","ai-gateway")))),Fe.length>0&&(0,t.createElement)("div",{className:"ai-studio-workflow-versions"},Fe.map(e=>(0,t.createElement)("div",{key:e.slug,className:"ai-studio-workflow-version"},(0,t.createElement)("div",null,(0,t.createElement)("div",{className:"ai-studio-workflow-version-title"},e.name),(0,t.createElement)("div",{className:"ai-studio-workflow-version-meta"},e.description)),(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>(async e=>{Ge(!0),We("");try{await s()({path:"/ai/v1/plugins/install",method:"POST",data:{slug:e}}),We(`Installed: ${e}`),await $t()}catch(e){We(e.message||"Install failed.")}finally{Ge(!1)}})(e.slug),disabled:Be},(0,o.__)("Install","ai-gateway"))))),(0,t.createElement)("div",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Installed plugins","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-workflow-versions"},Oe.map(e=>(0,t.createElement)("div",{key:e.file,className:"ai-studio-workflow-version"},(0,t.createElement)("div",null,(0,t.createElement)("div",{className:"ai-studio-workflow-version-title"},e.name),(0,t.createElement)("div",{className:"ai-studio-workflow-version-meta"},e.version," ",e.active?(0,o.__)("(active)","ai-gateway"):"")),(0,t.createElement)("div",{className:"ai-studio-workflow-node-actions"},e.active?(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>(async e=>{Ge(!0),We("");try{await s()({path:"/ai/v1/plugins/deactivate",method:"POST",data:{plugin_file:e}}),await $t()}catch(e){We(e.message||"Deactivation failed.")}finally{Ge(!1)}})(e.file),disabled:Be},(0,o.__)("Deactivate","ai-gateway")):(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>(async e=>{Ge(!0),We("");try{await s()({path:"/ai/v1/plugins/activate",method:"POST",data:{plugin_file:e}}),await $t()}catch(e){We(e.message||"Activation failed.")}finally{Ge(!1)}})(e.file),disabled:Be},(0,o.__)("Activate","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>(async e=>{if(window.confirm("Delete this plugin?")){Ge(!0),We("");try{await s()({path:"/ai/v1/plugins/delete",method:"POST",data:{plugin_file:e}}),await $t()}catch(e){We(e.message||"Delete failed.")}finally{Ge(!1)}}})(e.file),disabled:Be},(0,o.__)("Delete","ai-gateway")))))),Le&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},Le)):"upload"===I?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("h3",null,(0,o.__)("Upload image","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{if(!window.wp||!window.wp.media)return void wt("Media library not available.");const e=window.wp.media({title:"Select image",multiple:!1,library:{type:"image"}});e.on("select",()=>{const t=e.state().get("selection").first();if(!t)return;const a=t.toJSON();Z({id:a.id,url:a.url})}),e.open()}},(0,o.__)("Open Media Library","ai-gateway")),(0,t.createElement)("input",{className:"ai-studio-input",value:Y,onChange:e=>J(e.target.value),placeholder:(0,o.__)("Image URL","ai-gateway")}),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{H("");try{const e=await s()({path:"/ai/v1/media/import",method:"POST",data:{url:Y}});H(e?.url?`Imported: ${e.url}`:"Imported"),e?.url&&Z({id:e.attachment_id,url:e.url})}catch(e){H(e.message||"Upload failed.")}}},(0,o.__)("Import","ai-gateway")),K?.url&&(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{let e=k;if(!e){const t=await s()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});e=t.id,N(e=>[t,...e]),S(t.id)}const t=`![image](${K.url})`;v(e=>[...e,{role:"user",content:t}]),pt(e,"user",t)}},(0,o.__)("Insert into chat","ai-gateway")),Q&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},Q)):"chain"===I?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("h3",null,(0,o.__)("Agent chain","ai-gateway")),e.map(e=>(0,t.createElement)("label",{key:e.id,className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:ee.includes(e.id),onChange:t=>{const a=t.target.checked;te(t=>a?[...t,e.id]:t.filter(t=>t!==e.id))}}),e.name)),(0,t.createElement)("button",{className:"ai-studio-button",onClick:Tt,disabled:C},(0,o.__)("Run chain","ai-gateway"))):"editor"===I?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("h3",null,(0,o.__)("Content editor","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Type","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:me,onChange:e=>pe(e.target.value)},(0,t.createElement)("option",{value:"article"},(0,o.__)("Article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Page","ai-gateway")),(0,t.createElement)("option",{value:"workflow"},(0,o.__)("Workflow","ai-gateway")))),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Title","ai-gateway")),(0,t.createElement)("input",{className:"ai-studio-input",value:we,onChange:e=>ge(e.target.value)})),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Content","ai-gateway")),(0,t.createElement)("textarea",{className:"ai-studio-textarea editor",rows:"8",value:ye,onChange:e=>ve(e.target.value)})),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Publish at (optional)","ai-gateway")),(0,t.createElement)("input",{className:"ai-studio-input",type:"datetime-local",value:Ye,onChange:e=>Je(e.target.value)})),he&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},he),Ke>0&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},`Draft ID: ${Ke}`),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{_e("");try{const e=await St(me,we,ye);_e(`Draft created: #${e.id}`)}catch(e){_e(e.message||"Failed to create draft.")}}},(0,o.__)("Create draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{const e=[...y].reverse().find(e=>"assistant"===e.role);e&&ve(e.content)}},(0,o.__)("Use last assistant","ai-gateway")),Ke>0&&(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{_e("");try{const e="page"===me?`/wp/v2/pages/${Ke}`:`/wp/v2/posts/${Ke}`;await s()({path:e,method:"POST",data:{title:`${we||"Draft"} (ID: ${Ke})`,content:ye}}),_e("Draft updated.")}catch(e){_e(e.message||"Failed to update draft.")}}},(0,o.__)("Update draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{_e("");try{const e=Ye?"Schedule this content?":"Publish this content now?";if(!window.confirm(e))return;const t=Ye?"future":"publish",a=Ye?new Date(Ye).toISOString():null,i=Ke||ze;if(!i)return void _e("No draft/post selected.");await Ct(me,Number(i),we,ye,t,a),_e(Ye?"Scheduled.":"Published."),tt("page"===me?`${window.location.origin}/?page_id=${i}&preview=true`:`${window.location.origin}/?p=${i}&preview=true`)}catch(e){_e(e.message||"Failed to publish.")}}},Ye?(0,o.__)("Schedule","ai-gateway"):(0,o.__)("Publish now","ai-gateway")),et&&(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>x("preview")},(0,o.__)("Open preview","ai-gateway"))):"split"===I?(0,t.createElement)("div",{className:"ai-studio-workspace-panel split"},(0,t.createElement)("div",{className:"ai-studio-split-panel"},(0,t.createElement)("h3",null,(0,o.__)("Content editor","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Type","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:me,onChange:e=>pe(e.target.value)},(0,t.createElement)("option",{value:"article"},(0,o.__)("Article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Page","ai-gateway")),(0,t.createElement)("option",{value:"workflow"},(0,o.__)("Workflow","ai-gateway")))),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Title","ai-gateway")),(0,t.createElement)("input",{className:"ai-studio-input",value:we,onChange:e=>ge(e.target.value)})),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Content","ai-gateway")),(0,t.createElement)("textarea",{className:"ai-studio-textarea editor",rows:"8",value:ye,onChange:e=>ve(e.target.value)})),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Publish at (optional)","ai-gateway")),(0,t.createElement)("input",{className:"ai-studio-input",type:"datetime-local",value:Ye,onChange:e=>Je(e.target.value)})),he&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},he),Ke>0&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},`Draft ID: ${Ke}`),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{_e("");try{const e=await St(me,we,ye);_e(`Draft created: #${e.id}`)}catch(e){_e(e.message||"Failed to create draft.")}}},(0,o.__)("Create draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{const e=[...y].reverse().find(e=>"assistant"===e.role);e&&ve(e.content)}},(0,o.__)("Use last assistant","ai-gateway")),Ke>0&&(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{_e("");try{const e="page"===me?`/wp/v2/pages/${Ke}`:`/wp/v2/posts/${Ke}`;await s()({path:e,method:"POST",data:{title:`${we||"Draft"} (ID: ${Ke})`,content:ye}}),_e("Draft updated.")}catch(e){_e(e.message||"Failed to update draft.")}}},(0,o.__)("Update draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{_e("");try{const e=Ye?"Schedule this content?":"Publish this content now?";if(!window.confirm(e))return;const t=Ye?"future":"publish",a=Ye?new Date(Ye).toISOString():null,i=Ke||ze;if(!i)return void _e("No draft/post selected.");await Ct(me,Number(i),we,ye,t,a),_e(Ye?"Scheduled.":"Published."),tt("page"===me?`${window.location.origin}/?page_id=${i}&preview=true`:`${window.location.origin}/?p=${i}&preview=true`)}catch(e){_e(e.message||"Failed to publish.")}}},Ye?(0,o.__)("Schedule","ai-gateway"):(0,o.__)("Publish now","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-split-panel"},(0,t.createElement)("h3",null,(0,o.__)("Preview","ai-gateway")),et?(0,t.createElement)("iframe",{title:"Preview",className:"ai-studio-iframe",src:et}):(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("No preview yet.","ai-gateway")))):"workflow"===I?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("div",{className:"ai-studio-workflow-header"},(0,t.createElement)("h3",null,(0,o.__)("Workflow builder","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-workflow-meta"},(0,t.createElement)("input",{className:"ai-studio-input",value:ct,placeholder:(0,o.__)("Version note (optional)","ai-gateway"),onChange:e=>rt(e.target.value)}),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{At(at,{saveVersion:!0,note:ct}),rt("")}},(0,o.__)("Save version","ai-gateway")))),ot.length>0&&(0,t.createElement)("div",{className:"ai-studio-workflow-versions"},ot.map((e,a)=>(0,t.createElement)("div",{key:a,className:"ai-studio-workflow-version"},(0,t.createElement)("div",null,(0,t.createElement)("div",{className:"ai-studio-workflow-version-title"},"Version "+(ot.length-a)),(0,t.createElement)("div",{className:"ai-studio-workflow-version-meta"},e.note||(0,o.__)("No note","ai-gateway")," · ",e.saved_at?new Date(e.saved_at).toLocaleString():"")),(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>{const t=u(e.workflow||[]);it(t),At(t)}},(0,o.__)("Restore","ai-gateway"))))),(0,t.createElement)("div",{className:"ai-studio-workflow-canvas",style:{width:Dt.width,height:Dt.height}},(0,t.createElement)("svg",{className:"ai-studio-workflow-lines",width:Dt.width,height:Dt.height},at.map((e,a)=>{const i=at[a+1];if(!i)return null;const n=(e.x||0)+240,s=(e.y||0)+70,o=i.x||0,l=(i.y||0)+70;return(0,t.createElement)("line",{key:`${e.id}-line`,x1:n,y1:s,x2:o,y2:l,stroke:"#334155",strokeWidth:"2"})})),at.map((a,i)=>(0,t.createElement)("div",{key:a.id,className:"ai-studio-workflow-node",style:{left:a.x,top:a.y,width:240}},(0,t.createElement)("div",{className:"ai-studio-workflow-node-header",onMouseDown:e=>((e,t)=>{if(0!==e.button)return;e.preventDefault();const a=e.currentTarget.closest(".ai-studio-workflow-canvas");if(!a)return;const i=a.getBoundingClientRect();ut({id:t.id,offsetX:e.clientX-i.left-(t.x||0),offsetY:e.clientY-i.top-(t.y||0)})})(e,a)},(0,t.createElement)("span",null,`#${i+1} ${a.type}`),(0,t.createElement)("div",{className:"ai-studio-workflow-node-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>xt(i,-1)},(0,o.__)("Up","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>xt(i,1)},(0,o.__)("Down","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>{const e=at.filter((e,t)=>t!==i);it(e),At(e)}},(0,o.__)("Remove","ai-gateway")))),(0,t.createElement)("div",{className:"ai-studio-workflow-node-body"},"run_agent"===a.type&&(0,t.createElement)("select",{className:"ai-studio-select",value:a.agentId||"",onChange:e=>{const t=[...at];t[i]={...a,agentId:Number(e.target.value)},it(t),At(t)}},(0,t.createElement)("option",{value:""},(0,o.__)("Select agent","ai-gateway")),e.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name))),"run_agent"===a.type&&(0,t.createElement)("textarea",{className:"ai-studio-textarea editor",rows:"3",placeholder:(0,o.__)("Prompt (optional)","ai-gateway"),value:a.prompt||"",onChange:e=>{const t=[...at];t[i]={...a,prompt:e.target.value},it(t),At(t)}}),("create_draft"===a.type||"update_draft"===a.type)&&(0,t.createElement)("select",{className:"ai-studio-select",value:a.postType||"article",onChange:e=>{const t=[...at];t[i]={...a,postType:e.target.value},it(t),At(t)}},(0,t.createElement)("option",{value:"article"},(0,o.__)("Article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Page","ai-gateway"))),"create_draft"===a.type&&(0,t.createElement)("input",{className:"ai-studio-input",value:a.title||"",placeholder:(0,o.__)("Draft title","ai-gateway"),onChange:e=>{const t=[...at];t[i]={...a,title:e.target.value},it(t),At(t)}}),"update_draft"===a.type&&(0,t.createElement)("input",{className:"ai-studio-input",value:a.postId||"",placeholder:(0,o.__)("Draft ID","ai-gateway"),onChange:e=>{const t=[...at];t[i]={...a,postId:Number(e.target.value)},it(t),At(t)}}))))),(0,t.createElement)("div",{className:"ai-studio-workflow-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>It({type:"run_agent",agentId:i||0})},(0,o.__)("Add Agent","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>It({type:"create_draft",postType:"article",title:""})},(0,o.__)("Add Draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>It({type:"update_draft",postType:"article",postId:0})},(0,o.__)("Update Draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>It({type:"insert_image"})},(0,o.__)("Insert Image","ai-gateway"))),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{if(at.length){st("Running...");try{let e="";for(const t of at){if("run_agent"===t.type){const a=t.prompt||m,i=await s()({path:"/ai/v1/run",method:"POST",data:{agent_id:t.agentId,instruction:a,inputs:w}});e=i?.mcp_response||i?.ollama_response||""}if("create_draft"===t.type){const a="page"===t.postType?"/wp/v2/pages":"/wp/v2/posts",i=await s()({path:a,method:"POST",data:{title:t.title||"Draft",content:e,status:"draft"}});if(Ze(i?.id||0),i?.id){const e=`${t.title||"Draft"} (ID: ${i.id})`;await s()({path:`${a}/${i.id}`,method:"POST",data:{title:e}}),tt("page"===t.postType?`${window.location.origin}/?page_id=${i.id}&preview=true`:`${window.location.origin}/?p=${i.id}&preview=true`)}}if("update_draft"===t.type&&t.postId){const a="page"===t.postType?`/wp/v2/pages/${t.postId}`:`/wp/v2/posts/${t.postId}`;await s()({path:a,method:"POST",data:{content:e}})}"insert_image"===t.type&&K?.url&&(e+=`\n\n![image](${K.url})`)}st("Done")}catch(e){wt(e.message||"Workflow failed."),st("Failed")}}else wt("No workflow nodes.")},disabled:C},(0,o.__)("Run workflow","ai-gateway")),et&&(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>x("preview")},(0,o.__)("Open preview","ai-gateway")),nt&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},nt)):"preview"===I?(0,t.createElement)("div",{className:"ai-studio-workspace-panel preview"},(0,t.createElement)("h3",null,(0,o.__)("Preview","ai-gateway")),et?(0,t.createElement)("iframe",{title:"Preview",className:"ai-studio-iframe",src:et}):(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("No preview yet.","ai-gateway"))):(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("Workspace","ai-gateway"))),O&&(0,t.createElement)("div",{className:"ai-studio-modal"},(0,t.createElement)("div",{className:"ai-studio-modal-card"},(0,t.createElement)("h3",null,(0,o.__)("Conversation actions","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Rename","ai-gateway")),(0,t.createElement)("input",{value:b.find(e=>e.id===O)?.name||"",onChange:e=>{const t=e.target.value;N(e=>e.map(e=>e.id===O?{...e,name:t}:e))}})),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Move to project","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:U,onChange:e=>M(Number(e.target.value))},(0,t.createElement)("option",{value:"0"},(0,o.__)("Select project","ai-gateway")),h.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Or create project","ai-gateway")),(0,t.createElement)("input",{value:F,onChange:e=>R(e.target.value),placeholder:(0,o.__)("New project name","ai-gateway")})),(0,t.createElement)("div",{className:"ai-studio-modal-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{const e=b.find(e=>e.id===O)?.name||"";await s()({path:`/ai/v1/conversations/${O}`,method:"PUT",data:{name:e}}),j(null)}},(0,o.__)("Rename","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{await(async e=>{let t=U;if(!t&&""!==F.trim()){const e=await s()({path:"/ai/v1/projects",method:"POST",data:{name:F.trim()}});_(t=>[e,...t]),t=e.id}t&&(await s()({path:`/ai/v1/conversations/${e}`,method:"PUT",data:{project_id:t}}),N(t=>t.filter(t=>t.id!==e)),k===e&&S(0))})(O),j(null)}},(0,o.__)("Move","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{await(async e=>{await s()({path:`/ai/v1/conversations/${e}/archive`,method:"POST"}),N(t=>t.filter(t=>t.id!==e)),k===e&&S(0)})(O),j(null)}},(0,o.__)("Archive","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{await(async e=>{await s()({path:`/ai/v1/conversations/${e}`,method:"DELETE"}),N(t=>t.filter(t=>t.id!==e)),k===e&&S(0)})(O),j(null)}},(0,o.__)("Delete","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>j(null)},(0,o.__)("Cancel","ai-gateway"))))),ce&&(0,t.createElement)("div",{className:"ai-studio-modal"},(0,t.createElement)("div",{className:"ai-studio-modal-card"},(0,t.createElement)("h3",null,(0,o.__)("Project actions","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Rename","ai-gateway")),(0,t.createElement)("input",{value:de,onChange:e=>ue(e.target.value)})),(0,t.createElement)("div",{className:"ai-studio-modal-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{await s()({path:`/ai/v1/projects/${E}`,method:"PUT",data:{name:de}}),_(e=>e.map(e=>e.id===E?{...e,name:de}:e)),re(!1)}},(0,o.__)("Rename","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{await s()({path:`/ai/v1/projects/${E}`,method:"DELETE"}),_(e=>e.filter(e=>e.id!==E)),f(0),re(!1)}},(0,o.__)("Delete","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>re(!1)},(0,o.__)("Cancel","ai-gateway"))))),A&&(0,t.createElement)("div",{className:"ai-studio-modal"},(0,t.createElement)("div",{className:"ai-studio-modal-card large"},(0,t.createElement)("div",{className:"ai-studio-modal-header"},(0,t.createElement)("h3",null,(0,o.__)("Settings","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-icon-button",onClick:()=>D(!1)},"X")),(0,t.createElement)("iframe",{title:"Settings",className:"ai-studio-iframe",src:`${vt}admin.php?page=ai-gateway-settings&studio=1`}))))}(0,a.registerBlockType)("ai-gateway/studio",{title:(0,o.__)("AI Studio","ai-gateway"),icon:"format-chat",category:"widgets",edit(){const e=(0,i.useBlockProps)({className:"ai-studio-block-placeholder"});return(0,t.createElement)("div",{...e},(0,o.__)("AI Studio App","ai-gateway"))},save(){const e=i.useBlockProps.save({className:"ai-studio-app"});return(0,t.createElement)("div",{...e})}});const p=()=>{const e=document.querySelectorAll(".ai-studio-app");e.length&&e.forEach(e=>{window.wp.element.render((0,t.createElement)(m,null),e)})};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p):p()})();