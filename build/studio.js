(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var i in a)e.o(a,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:a[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.blocks,i=window.wp.blockEditor,n=window.wp.apiFetch;var s=e.n(n);const o=window.wp.i18n,l=window.wp.element,r=window.AIGatewaySettings||{restUrl:"",nonce:"",agents:[]};r.nonce&&s().use(s().createNonceMiddleware(r.nonce));const c=()=>`node_${Date.now()}_${Math.floor(1e3*Math.random())}`,d=e=>(Array.isArray(e)?e:[]).map((e,t)=>{const a=40+40*t,i=40+100*t;return{id:e.id||c(),type:e.type||"run_agent",x:Number.isFinite(e.x)?e.x:a,y:Number.isFinite(e.y)?e.y:i,...e}});function m(){const[e,a]=(0,l.useState)(r.agents||[]),[i,n]=(0,l.useState)(r.studioDefaultAgent||r.agents?.[0]?.id||0),[m,u]=(0,l.useState)(""),[p,w]=(0,l.useState)({}),[g,y]=(0,l.useState)([]),[v,_]=(0,l.useState)([]),[E,h]=(0,l.useState)(0),[f,b]=(0,l.useState)([]),[N,k]=(0,l.useState)(0),[C,S]=(0,l.useState)(!1),[$,T]=(0,l.useState)(""),[P,x]=(0,l.useState)(!1),[D,A]=(0,l.useState)(window.localStorage.getItem("ai_gateway_workspace_mode")||"chat"),[O,I]=(0,l.useState)(null),[j,M]=(0,l.useState)(0),[R,U]=(0,l.useState)(""),[F,L]=(0,l.useState)(!1),[W,B]=(0,l.useState)(Number(window.localStorage.getItem("ai_gateway_workspace_width"))||360),[G,X]=(0,l.useState)(!1),[q,V]=(0,l.useState)([]),[Y,J]=(0,l.useState)(""),[z,H]=(0,l.useState)(""),[K,Q]=(0,l.useState)(null),[Z,ee]=(0,l.useState)([]),[te,ae]=(0,l.useState)(!1),[ie,ne]=(0,l.useState)(!1),[se,oe]=(0,l.useState)(!1),[le,re]=(0,l.useState)(!1),[ce,de]=(0,l.useState)(""),[me,ue]=(0,l.useState)("article"),[pe,we]=(0,l.useState)(""),[ge,ye]=(0,l.useState)(""),[ve,_e]=(0,l.useState)(""),[Ee,he]=(0,l.useState)("append"),[fe,be]=(0,l.useState)("article"),[Ne,ke]=(0,l.useState)(""),[Ce,Se]=(0,l.useState)([]),[$e,Te]=(0,l.useState)(0),[Pe,xe]=(0,l.useState)(""),[De,Ae]=(0,l.useState)([]),[Oe,Ie]=(0,l.useState)(""),[je,Me]=(0,l.useState)([]),[Re,Ue]=(0,l.useState)(""),[Fe,Le]=(0,l.useState)(null),We=(0,l.useRef)([]),Be=async(e,t,a)=>{if(e)try{await s()({path:`/ai/v1/conversations/${e}/messages`,method:"POST",data:{role:t,content:a}})}catch(e){Ge(e.message||"Failed to save message.")}},Ge=e=>{T(e),Se(t=>[{message:e,time:(new Date).toISOString()},...t.slice(0,9)])},Xe=(0,l.useMemo)(()=>e.find(e=>e.id===i),[e,i]),qe=(e=>(e||[]).map(e=>"string"==typeof e?{key:e,label:e,type:"text"}:e&&e.key?{key:e.key,label:e.label||e.key,type:e.type||"text",options:e.options||[],placeholder:e.placeholder||"",required:Boolean(e.required),env:e.env||""}:null).filter(Boolean))(Xe?.input_schema||[]).filter(e=>!e.env),Ve=r.adminUrl||"/wp-admin/",Ye=Xe?.tools||[],Je=(0,l.useMemo)(()=>{const t={};return e.forEach(e=>{t[e.id]=e}),t},[e]),ze=()=>{const e={};qe.forEach(t=>{e[t.key]=""}),w(e)},He=()=>{const e=f.find(e=>e.id===N);return e?.name||"Draft"},Ke=()=>{const e=[...g].reverse().find(e=>"assistant"===e.role);if(e?.content)return e.content;const t=[...g].reverse().find(e=>"user"===e.role);return t?.content?t.content:m||""},Qe=async(e,t,a)=>{const i="page"===e?"/wp/v2/pages":"/wp/v2/posts",n=await s()({path:i,method:"POST",data:{title:t||"Draft",content:a,status:"draft"}});if(Te(n?.id||0),n?.id){const a=`${t||"Draft"} (ID: ${n.id})`;await s()({path:`${i}/${n.id}`,method:"POST",data:{title:a}}),xe("page"===e?`${window.location.origin}/?page_id=${n.id}&preview=true`:`${window.location.origin}/?p=${n.id}&preview=true`)}return n};(0,l.useEffect)(()=>{if(e.length)return;let t=!0;return(async()=>{try{const e=await s()({path:"/ai/v1/agents?enabled=1",method:"GET"});if(!t)return;const i=Array.isArray(e)?e:[];a(i);const o=r.studioDefaultAgent||0,l=i.find(e=>e.id===o);n(l?.id||i[0]?.id||0)}catch(e){t&&Ge(e.message||"Failed to load agents.")}})(),()=>{t=!1}},[e.length]),(0,l.useEffect)(()=>{ze(),V(Xe?.tools||[])},[i]),(0,l.useEffect)(()=>{if(!G)return;const e=e=>{const t=Math.min(640,Math.max(260,window.innerWidth-e.clientX-24));B(t)},t=()=>{X(!1)};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[G]),(0,l.useEffect)(()=>{if(!Fe)return;const e=e=>{const t=document.querySelector(".ai-studio-workflow-canvas");if(!t)return;const a=t.getBoundingClientRect(),i=e.clientX-a.left-Fe.offsetX,n=e.clientY-a.top-Fe.offsetY;Ae(e=>e.map(e=>e.id===Fe.id?{...e,x:Math.max(20,i),y:Math.max(20,n)}:e))},t=()=>{Le(null),tt(We.current)};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[Fe]),(0,l.useEffect)(()=>{window.localStorage.setItem("ai_gateway_workspace_mode",D)},[D]),(0,l.useEffect)(()=>{window.localStorage.setItem("ai_gateway_workspace_width",String(W))},[W]),(0,l.useEffect)(()=>{let e=!0;return(async()=>{try{const t=await s()({path:"/ai/v1/projects",method:"GET"}),a=Array.isArray(t)?t:[];if(!e)return;if(!a.length){const e=await s()({path:"/ai/v1/projects",method:"POST",data:{name:"General"}});return _([e]),void h(e.id)}_(a),h(a[0]?.id||0)}catch(t){e&&Ge(t.message||"Failed to load projects.")}})(),()=>{e=!1}},[]),(0,l.useEffect)(()=>{if(!E)return;let e=!0;return(async()=>{try{const t=await s()({path:`/ai/v1/conversations?project_id=${E}&include_archived=${ie?"1":"0"}`,method:"GET"});if(!e)return;const a=Array.isArray(t)?t:[];b(a),k(a[0]?.id||0)}catch(t){e&&Ge(t.message||"Failed to load conversations.")}})(),()=>{e=!1}},[E,ie]),(0,l.useEffect)(()=>{if(!N)return void y([]);let e=!0;return(async()=>{try{const t=await s()({path:`/ai/v1/conversations/${N}`,method:"GET"});e&&t?.messages&&y(t.messages)}catch(t){e&&Ge(t.message||"Failed to load conversation.")}})(),()=>{e=!1}},[N]),(0,l.useEffect)(()=>{if(!N)return void Ae([]);let e=!0;return(async()=>{try{const t=await s()({path:`/ai/v1/conversations/${N}/workflow`,method:"GET"});e&&(Ae(d(t?.workflow)),Me(Array.isArray(t?.versions)?t.versions:[]))}catch(e){Ge(e.message||"Failed to load workflow.")}})(),()=>{e=!1}},[N]),(0,l.useEffect)(()=>{We.current=De},[De]);const Ze=(e,t)=>{y(a=>{if(!a.length)return a;const i=[...a],n=i[i.length-1];return"assistant"!==n.role?a:(i[i.length-1]={...n,content:t?e:n.content+e},i)})},et=async()=>{S(!0),oe(!0),T("");const e=q.length?`${m}\n\nTools: ${q.join(", ")}`:m;let t=N;if(!t){const e=await s()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});t=e.id,b(t=>[e,...t]),k(e.id)}y(e=>[...e,{role:"user",content:m}]),Be(t,"user",e);try{for(const a of Z){const i=await s()({path:"/ai/v1/run",method:"POST",data:{agent_id:a,instruction:e,inputs:p}}),n=i?.mcp_response||i?.ollama_response||i?.error||"",o=`${Je[a]?.name||"Agent"}: ${n}`;y(e=>[...e,{role:"assistant",content:o}]),Be(t,"assistant",o)}}catch(e){Ge(e.message||"Chain failed.")}finally{S(!1),oe(!1),u("")}},tt=async(e,t={})=>{if(!N)return;const a={workflow:e};t.saveVersion&&(a.save_version=!0,a.note=t.note||"");const i=await s()({path:`/ai/v1/conversations/${N}/workflow`,method:"POST",data:a});i?.versions&&Me(i.versions)};(0,l.useEffect)(()=>{if(!N||0===g.length)return;const e=setTimeout(async()=>{try{await s()({path:`/ai/v1/conversations/${N}/draft`,method:"POST",data:{messages:g}})}catch(e){Ge(e.message||"Failed to save draft.")}},1200);return()=>clearTimeout(e)},[N,g]);const at=(0,l.useMemo)(()=>{const e=De.reduce((e,t)=>Math.max(e,t.x||0),0),t=De.reduce((e,t)=>Math.max(e,t.y||0),0);return{width:Math.max(520,e+240+80),height:Math.max(360,t+140+80)}},[De]),it=e=>{const t=De.length,a=[...De,{id:c(),x:40+40*t,y:40+100*t,...e}];Ae(a),tt(a)},nt=(e,t)=>{const a=[...De],i=e+t;if(i<0||i>=a.length)return;const[n]=a.splice(e,1);a.splice(i,0,n),Ae(a),tt(a)};return(0,t.createElement)("div",{className:"ai-studio-app",style:{gridTemplateColumns:`280px 1fr ${W}px`}},(0,t.createElement)("aside",{className:"ai-studio-sidebar"},(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Projects","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-project-row"},(0,t.createElement)("select",{className:"ai-studio-select",value:E,onChange:e=>h(Number(e.target.value))},v.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name))),(0,t.createElement)("button",{type:"button",className:"ai-studio-icon-button",onClick:()=>{re(!0);const e=v.find(e=>e.id===E);de(e?.name||"")}},"..."))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Conversations","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:ie,onChange:e=>ne(e.target.checked)}),(0,o.__)("Show archived","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-conversation-list"},f.map(e=>(0,t.createElement)("div",{key:e.id,className:"ai-studio-conversation-row"},(0,t.createElement)("button",{type:"button",className:"ai-studio-conversation "+(e.id===N?"active":""),onClick:()=>k(e.id)},(0,t.createElement)("div",{className:"ai-studio-conversation-title"},e.name),e.archived&&(0,t.createElement)("div",{className:"ai-studio-conversation-last"},(0,o.__)("Archived","ai-gateway")),e.last&&(0,t.createElement)("div",{className:"ai-studio-conversation-last"},e.last)),(0,t.createElement)("button",{type:"button",className:"ai-studio-icon-button",onClick:()=>{I(e.id),M(0),U("")}},"...")))),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:async()=>{const e=await s()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});b(t=>[e,...t]),k(e.id)}},(0,o.__)("New chat","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Agents","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:i,onChange:e=>n(Number(e.target.value))},e.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Tools","ai-gateway")),0===Ye.length&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},(0,o.__)("Assigned via agent.","ai-gateway")),Ye.map(e=>(0,t.createElement)("label",{key:e,className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:q.includes(e),onChange:t=>{const a=t.target.checked;V(t=>a?[...t,e]:t.filter(t=>t!==e))}}),e))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Settings","ai-gateway")),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:()=>x(!0)},(0,o.__)("Open settings","ai-gateway")),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:()=>A("agents")},(0,o.__)("Agents editor","ai-gateway")),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:()=>A("admin")},(0,o.__)("WP Admin","ai-gateway")))),(0,t.createElement)("main",{className:"ai-studio-main"},(0,t.createElement)("div",{className:"ai-studio-topbar"},(0,t.createElement)("div",{className:"ai-studio-topbar-left"},(0,t.createElement)("span",{className:"ai-studio-topbar-label"},(0,o.__)("Active agent","ai-gateway")),(0,t.createElement)("span",{className:"ai-studio-topbar-value"},Xe?.name||(0,o.__)("None","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-topbar-right"},(0,t.createElement)("span",{className:"ai-studio-status-dot"}),(0,t.createElement)("span",null,(0,o.__)("Ollama: online","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-tabs"},[{id:"chat",label:(0,o.__)("Chat","ai-gateway")},{id:"editor",label:(0,o.__)("Editor","ai-gateway")},{id:"split",label:(0,o.__)("Split","ai-gateway")},{id:"workflow",label:(0,o.__)("Workflow","ai-gateway")},{id:"preview",label:(0,o.__)("Preview","ai-gateway")},{id:"agents",label:(0,o.__)("Agents","ai-gateway")},{id:"admin",label:(0,o.__)("WP Admin","ai-gateway")}].map(e=>(0,t.createElement)("button",{key:e.id,className:"ai-studio-tab "+(D===e.id?"active":""),onClick:()=>A(e.id)},e.label))))),(0,t.createElement)("div",{className:"ai-studio-chat"},g.map((e,a)=>(0,t.createElement)("div",{key:a,className:`ai-studio-message ai-studio-${e.role}`},(0,t.createElement)("div",{className:"ai-studio-message-role"},e.role),(0,t.createElement)("div",{className:"ai-studio-message-content"},e.content))),se&&(0,t.createElement)("div",{className:"ai-studio-typing"},Xe?.name||(0,o.__)("Agent","ai-gateway")," ",(0,o.__)("is typing...","ai-gateway"))),Ce.length>0&&(0,t.createElement)("div",{className:"ai-studio-error-log"},(0,t.createElement)("strong",null,(0,o.__)("Errors","ai-gateway")),Ce.map((e,a)=>(0,t.createElement)("div",{key:a,className:"ai-studio-error-item"},e.message))),qe.length>0&&(0,t.createElement)("div",{className:"ai-studio-inputs"},qe.map(e=>(0,t.createElement)("label",{key:e.key,className:"ai-studio-field"},(0,t.createElement)("span",null,e.label),(0,t.createElement)("input",{type:"number"===e.type?"number":"url"===e.type?"url":"text",value:p[e.key]||"",placeholder:e.placeholder,onChange:t=>w(a=>({...a,[e.key]:t.target.value}))})))),(0,t.createElement)("div",{className:"ai-studio-composer"},$&&(0,t.createElement)("div",{className:"ai-studio-error"},$),(0,t.createElement)("div",{className:"ai-studio-composer-row"},(0,t.createElement)("button",{className:"ai-studio-button icon",type:"button",title:(0,o.__)("Add","ai-gateway"),onClick:()=>L(e=>!e)},"+"),F&&(0,t.createElement)("div",{className:"ai-studio-plus-menu"},(0,t.createElement)("button",{type:"button",onClick:()=>{L(!1),A("tools")}},(0,o.__)("Tools","ai-gateway")),(0,t.createElement)("button",{type:"button",onClick:()=>{L(!1),A("upload")}},(0,o.__)("Upload image","ai-gateway")),(0,t.createElement)("button",{type:"button",onClick:()=>{L(!1),A("chain")}},(0,o.__)("Chain agents","ai-gateway"))),(0,t.createElement)("textarea",{className:"ai-studio-textarea",rows:"3",placeholder:(0,o.__)("Ask something...","ai-gateway"),value:m,onChange:e=>u(e.target.value)}),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{if(!i)return void Ge("No agent selected.");if(te&&Z.length>0)return void await et();S(!0),oe(!0),T("");const e=q.length?`${m}\n\nTools: ${q.join(", ")}`:m;let t=N;if(!t){const e=await s()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});t=e.id,b(t=>[e,...t]),k(e.id)}const a={role:"user",content:m};y(e=>[...e,a,{role:"assistant",content:""}]),Be(t,"user",e);try{const a=`${r.restUrl?r.restUrl.replace(/\/$/,""):"/wp-json/ai/v1"}/run/stream`,n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":r.nonce||""},body:JSON.stringify({agent_id:i,instruction:e,inputs:p})}),s=n.headers.get("content-type")||"";if(!n.ok||!n.body||!s.includes("text/event-stream"))throw new Error("Stream unavailable");const o=n.body.getReader(),l=new TextDecoder("utf-8");let c="";for(;;){const{value:e,done:a}=await o.read();if(a)break;c+=l.decode(e,{stream:!0});const i=c.split("\n\n");c=i.pop()||"",i.forEach(e=>{e.split("\n").forEach(e=>{if(!e.startsWith("data: "))return;const a=e.slice(6).trim();if(a)try{const e=JSON.parse(a);if(e.error)return void Ge(e.error);e.delta&&Ze(e.delta,!1),e.done&&e.full&&(Ze(e.full,!0),Be(t,"assistant",e.full),oe(!1))}catch(e){Ge(e.message||"Stream parse error.")}})})}}catch(a){try{const a=await s()({path:"/ai/v1/run",method:"POST",data:{agent_id:i,instruction:e,inputs:p}});if(a?.error)Ge(a.error);else{const e=a?.mcp_response||a?.ollama_response||"";Ze(e,!0),Be(t,"assistant",e)}}catch(e){Ge(e.message||a.message||"Stream failed.")}}finally{S(!1),u(""),oe(!1)}},disabled:C},C?(0,o.__)("Running...","ai-gateway"):(0,o.__)("Send","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:ze},(0,o.__)("Reset","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:te,onChange:e=>ae(e.target.checked)}),(0,o.__)("Use chain","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-chat-tools"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Chat tools","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-chat-tools-row"},(0,t.createElement)("select",{className:"ai-studio-select",value:Ee,onChange:e=>he(e.target.value)},(0,t.createElement)("option",{value:"append"},(0,o.__)("Append to editor","ai-gateway")),(0,t.createElement)("option",{value:"replace"},(0,o.__)("Replace editor","ai-gateway")),(0,t.createElement)("option",{value:"section"},(0,o.__)("Add as section","ai-gateway"))),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{const e=Ke();if(!e)return void Ge("No chat content to inject.");const t=pe||He();let a="";a="replace"===Ee?e:"section"===Ee?ge?`${ge}\n\n## ${t}\n\n${e}`:`## ${t}\n\n${e}`:ge?`${ge}\n\n${e}`:e,we(t),ye(a),A("editor"),ke("Injected into editor.")}},(0,o.__)("Inject into editor","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-chat-tools-row"},(0,t.createElement)("select",{className:"ai-studio-select",value:fe,onChange:e=>be(e.target.value)},(0,t.createElement)("option",{value:"article"},(0,o.__)("Create article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Create page","ai-gateway"))),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{const e=Ke();if(!e)return void Ge("No chat content to create draft.");const t=pe||He();ke(""),_e(""),A("editor"),ue(fe),we(t),ye(e);try{const a=await Qe(fe,t,e);_e(`Draft created: #${a.id}`),ke(`Draft created: #${a.id}`)}catch(e){const t=e.message||"Failed to create draft.";_e(t),ke(t)}}},(0,o.__)("Create from chat","ai-gateway"))),Ne&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},Ne)))),(0,t.createElement)("aside",{className:"ai-studio-workspace"},(0,t.createElement)("div",{className:"ai-studio-resizer",onMouseDown:()=>X(!0),title:(0,o.__)("Resize","ai-gateway")}),"agents"===D?(0,t.createElement)("iframe",{title:"Agents",className:"ai-studio-iframe",src:`${Ve}admin.php?page=ai-gateway-agents&action=edit&agent_id=${i}&studio=1`}):"admin"===D?(0,t.createElement)("iframe",{title:"WP Admin",className:"ai-studio-iframe",src:`${Ve}admin.php`}):"tools"===D?(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("Tools panel (coming soon)","ai-gateway")):"upload"===D?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("h3",null,(0,o.__)("Upload image","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{if(!window.wp||!window.wp.media)return void Ge("Media library not available.");const e=window.wp.media({title:"Select image",multiple:!1,library:{type:"image"}});e.on("select",()=>{const t=e.state().get("selection").first();if(!t)return;const a=t.toJSON();Q({id:a.id,url:a.url})}),e.open()}},(0,o.__)("Open Media Library","ai-gateway")),(0,t.createElement)("input",{className:"ai-studio-input",value:Y,onChange:e=>J(e.target.value),placeholder:(0,o.__)("Image URL","ai-gateway")}),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{H("");try{const e=await s()({path:"/ai/v1/media/import",method:"POST",data:{url:Y}});H(e?.url?`Imported: ${e.url}`:"Imported"),e?.url&&Q({id:e.attachment_id,url:e.url})}catch(e){H(e.message||"Upload failed.")}}},(0,o.__)("Import","ai-gateway")),K?.url&&(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{let e=N;if(!e){const t=await s()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});e=t.id,b(e=>[t,...e]),k(t.id)}const t=`![image](${K.url})`;y(e=>[...e,{role:"user",content:t}]),Be(e,"user",t)}},(0,o.__)("Insert into chat","ai-gateway")),z&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},z)):"chain"===D?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("h3",null,(0,o.__)("Agent chain","ai-gateway")),e.map(e=>(0,t.createElement)("label",{key:e.id,className:"ai-studio-checkbox"},(0,t.createElement)("input",{type:"checkbox",checked:Z.includes(e.id),onChange:t=>{const a=t.target.checked;ee(t=>a?[...t,e.id]:t.filter(t=>t!==e.id))}}),e.name)),(0,t.createElement)("button",{className:"ai-studio-button",onClick:et,disabled:C},(0,o.__)("Run chain","ai-gateway"))):"editor"===D?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("h3",null,(0,o.__)("Content editor","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Type","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:me,onChange:e=>ue(e.target.value)},(0,t.createElement)("option",{value:"article"},(0,o.__)("Article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Page","ai-gateway")),(0,t.createElement)("option",{value:"workflow"},(0,o.__)("Workflow","ai-gateway")))),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Title","ai-gateway")),(0,t.createElement)("input",{className:"ai-studio-input",value:pe,onChange:e=>we(e.target.value)})),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Content","ai-gateway")),(0,t.createElement)("textarea",{className:"ai-studio-textarea editor",rows:"8",value:ge,onChange:e=>ye(e.target.value)})),ve&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},ve),$e>0&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},`Draft ID: ${$e}`),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{_e("");try{const e=await Qe(me,pe,ge);_e(`Draft created: #${e.id}`)}catch(e){_e(e.message||"Failed to create draft.")}}},(0,o.__)("Create draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{const e=[...g].reverse().find(e=>"assistant"===e.role);e&&ye(e.content)}},(0,o.__)("Use last assistant","ai-gateway")),$e>0&&(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{_e("");try{const e="page"===me?`/wp/v2/pages/${$e}`:`/wp/v2/posts/${$e}`;await s()({path:e,method:"POST",data:{title:`${pe||"Draft"} (ID: ${$e})`,content:ge}}),_e("Draft updated.")}catch(e){_e(e.message||"Failed to update draft.")}}},(0,o.__)("Update draft","ai-gateway")),Pe&&(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>A("preview")},(0,o.__)("Open preview","ai-gateway"))):"split"===D?(0,t.createElement)("div",{className:"ai-studio-workspace-panel split"},(0,t.createElement)("div",{className:"ai-studio-split-panel"},(0,t.createElement)("h3",null,(0,o.__)("Content editor","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Type","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:me,onChange:e=>ue(e.target.value)},(0,t.createElement)("option",{value:"article"},(0,o.__)("Article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Page","ai-gateway")),(0,t.createElement)("option",{value:"workflow"},(0,o.__)("Workflow","ai-gateway")))),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Title","ai-gateway")),(0,t.createElement)("input",{className:"ai-studio-input",value:pe,onChange:e=>we(e.target.value)})),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Content","ai-gateway")),(0,t.createElement)("textarea",{className:"ai-studio-textarea editor",rows:"8",value:ge,onChange:e=>ye(e.target.value)})),ve&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},ve),$e>0&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},`Draft ID: ${$e}`),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{_e("");try{const e=await Qe(me,pe,ge);_e(`Draft created: #${e.id}`)}catch(e){_e(e.message||"Failed to create draft.")}}},(0,o.__)("Create draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{const e=[...g].reverse().find(e=>"assistant"===e.role);e&&ye(e.content)}},(0,o.__)("Use last assistant","ai-gateway")),$e>0&&(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{_e("");try{const e="page"===me?`/wp/v2/pages/${$e}`:`/wp/v2/posts/${$e}`;await s()({path:e,method:"POST",data:{title:`${pe||"Draft"} (ID: ${$e})`,content:ge}}),_e("Draft updated.")}catch(e){_e(e.message||"Failed to update draft.")}}},(0,o.__)("Update draft","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-split-panel"},(0,t.createElement)("h3",null,(0,o.__)("Preview","ai-gateway")),Pe?(0,t.createElement)("iframe",{title:"Preview",className:"ai-studio-iframe",src:Pe}):(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("No preview yet.","ai-gateway")))):"workflow"===D?(0,t.createElement)("div",{className:"ai-studio-workspace-panel"},(0,t.createElement)("div",{className:"ai-studio-workflow-header"},(0,t.createElement)("h3",null,(0,o.__)("Workflow builder","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-workflow-meta"},(0,t.createElement)("input",{className:"ai-studio-input",value:Re,placeholder:(0,o.__)("Version note (optional)","ai-gateway"),onChange:e=>Ue(e.target.value)}),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>{tt(De,{saveVersion:!0,note:Re}),Ue("")}},(0,o.__)("Save version","ai-gateway")))),je.length>0&&(0,t.createElement)("div",{className:"ai-studio-workflow-versions"},je.map((e,a)=>(0,t.createElement)("div",{key:a,className:"ai-studio-workflow-version"},(0,t.createElement)("div",null,(0,t.createElement)("div",{className:"ai-studio-workflow-version-title"},"Version "+(je.length-a)),(0,t.createElement)("div",{className:"ai-studio-workflow-version-meta"},e.note||(0,o.__)("No note","ai-gateway")," Â· ",e.saved_at?new Date(e.saved_at).toLocaleString():"")),(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>{const t=d(e.workflow||[]);Ae(t),tt(t)}},(0,o.__)("Restore","ai-gateway"))))),(0,t.createElement)("div",{className:"ai-studio-workflow-canvas",style:{width:at.width,height:at.height}},(0,t.createElement)("svg",{className:"ai-studio-workflow-lines",width:at.width,height:at.height},De.map((e,a)=>{const i=De[a+1];if(!i)return null;const n=(e.x||0)+240,s=(e.y||0)+70,o=i.x||0,l=(i.y||0)+70;return(0,t.createElement)("line",{key:`${e.id}-line`,x1:n,y1:s,x2:o,y2:l,stroke:"#334155",strokeWidth:"2"})})),De.map((a,i)=>(0,t.createElement)("div",{key:a.id,className:"ai-studio-workflow-node",style:{left:a.x,top:a.y,width:240}},(0,t.createElement)("div",{className:"ai-studio-workflow-node-header",onMouseDown:e=>((e,t)=>{if(0!==e.button)return;e.preventDefault();const a=e.currentTarget.closest(".ai-studio-workflow-canvas");if(!a)return;const i=a.getBoundingClientRect();Le({id:t.id,offsetX:e.clientX-i.left-(t.x||0),offsetY:e.clientY-i.top-(t.y||0)})})(e,a)},(0,t.createElement)("span",null,`#${i+1} ${a.type}`),(0,t.createElement)("div",{className:"ai-studio-workflow-node-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>nt(i,-1)},(0,o.__)("Up","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>nt(i,1)},(0,o.__)("Down","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary tiny",onClick:()=>{const e=De.filter((e,t)=>t!==i);Ae(e),tt(e)}},(0,o.__)("Remove","ai-gateway")))),(0,t.createElement)("div",{className:"ai-studio-workflow-node-body"},"run_agent"===a.type&&(0,t.createElement)("select",{className:"ai-studio-select",value:a.agentId||"",onChange:e=>{const t=[...De];t[i]={...a,agentId:Number(e.target.value)},Ae(t),tt(t)}},(0,t.createElement)("option",{value:""},(0,o.__)("Select agent","ai-gateway")),e.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name))),"run_agent"===a.type&&(0,t.createElement)("textarea",{className:"ai-studio-textarea editor",rows:"3",placeholder:(0,o.__)("Prompt (optional)","ai-gateway"),value:a.prompt||"",onChange:e=>{const t=[...De];t[i]={...a,prompt:e.target.value},Ae(t),tt(t)}}),("create_draft"===a.type||"update_draft"===a.type)&&(0,t.createElement)("select",{className:"ai-studio-select",value:a.postType||"article",onChange:e=>{const t=[...De];t[i]={...a,postType:e.target.value},Ae(t),tt(t)}},(0,t.createElement)("option",{value:"article"},(0,o.__)("Article","ai-gateway")),(0,t.createElement)("option",{value:"page"},(0,o.__)("Page","ai-gateway"))),"create_draft"===a.type&&(0,t.createElement)("input",{className:"ai-studio-input",value:a.title||"",placeholder:(0,o.__)("Draft title","ai-gateway"),onChange:e=>{const t=[...De];t[i]={...a,title:e.target.value},Ae(t),tt(t)}}),"update_draft"===a.type&&(0,t.createElement)("input",{className:"ai-studio-input",value:a.postId||"",placeholder:(0,o.__)("Draft ID","ai-gateway"),onChange:e=>{const t=[...De];t[i]={...a,postId:Number(e.target.value)},Ae(t),tt(t)}}))))),(0,t.createElement)("div",{className:"ai-studio-workflow-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>it({type:"run_agent",agentId:i||0})},(0,o.__)("Add Agent","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>it({type:"create_draft",postType:"article",title:""})},(0,o.__)("Add Draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>it({type:"update_draft",postType:"article",postId:0})},(0,o.__)("Update Draft","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>it({type:"insert_image"})},(0,o.__)("Insert Image","ai-gateway"))),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{if(De.length){Ie("Running...");try{let e="";for(const t of De){if("run_agent"===t.type){const a=t.prompt||m,i=await s()({path:"/ai/v1/run",method:"POST",data:{agent_id:t.agentId,instruction:a,inputs:p}});e=i?.mcp_response||i?.ollama_response||""}if("create_draft"===t.type){const a="page"===t.postType?"/wp/v2/pages":"/wp/v2/posts",i=await s()({path:a,method:"POST",data:{title:t.title||"Draft",content:e,status:"draft"}});if(Te(i?.id||0),i?.id){const e=`${t.title||"Draft"} (ID: ${i.id})`;await s()({path:`${a}/${i.id}`,method:"POST",data:{title:e}}),xe("page"===t.postType?`${window.location.origin}/?page_id=${i.id}&preview=true`:`${window.location.origin}/?p=${i.id}&preview=true`)}}if("update_draft"===t.type&&t.postId){const a="page"===t.postType?`/wp/v2/pages/${t.postId}`:`/wp/v2/posts/${t.postId}`;await s()({path:a,method:"POST",data:{content:e}})}"insert_image"===t.type&&K?.url&&(e+=`\n\n![image](${K.url})`)}Ie("Done")}catch(e){Ge(e.message||"Workflow failed."),Ie("Failed")}}else Ge("No workflow nodes.")},disabled:C},(0,o.__)("Run workflow","ai-gateway")),Pe&&(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>A("preview")},(0,o.__)("Open preview","ai-gateway")),Oe&&(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},Oe)):"preview"===D?(0,t.createElement)("div",{className:"ai-studio-workspace-panel preview"},(0,t.createElement)("h3",null,(0,o.__)("Preview","ai-gateway")),Pe?(0,t.createElement)("iframe",{title:"Preview",className:"ai-studio-iframe",src:Pe}):(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("No preview yet.","ai-gateway"))):(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("Workspace","ai-gateway"))),O&&(0,t.createElement)("div",{className:"ai-studio-modal"},(0,t.createElement)("div",{className:"ai-studio-modal-card"},(0,t.createElement)("h3",null,(0,o.__)("Conversation actions","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Rename","ai-gateway")),(0,t.createElement)("input",{value:f.find(e=>e.id===O)?.name||"",onChange:e=>{const t=e.target.value;b(e=>e.map(e=>e.id===O?{...e,name:t}:e))}})),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Move to project","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:j,onChange:e=>M(Number(e.target.value))},(0,t.createElement)("option",{value:"0"},(0,o.__)("Select project","ai-gateway")),v.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Or create project","ai-gateway")),(0,t.createElement)("input",{value:R,onChange:e=>U(e.target.value),placeholder:(0,o.__)("New project name","ai-gateway")})),(0,t.createElement)("div",{className:"ai-studio-modal-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{const e=f.find(e=>e.id===O)?.name||"";await s()({path:`/ai/v1/conversations/${O}`,method:"PUT",data:{name:e}}),I(null)}},(0,o.__)("Rename","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{await(async e=>{let t=j;if(!t&&""!==R.trim()){const e=await s()({path:"/ai/v1/projects",method:"POST",data:{name:R.trim()}});_(t=>[e,...t]),t=e.id}t&&(await s()({path:`/ai/v1/conversations/${e}`,method:"PUT",data:{project_id:t}}),b(t=>t.filter(t=>t.id!==e)),N===e&&k(0))})(O),I(null)}},(0,o.__)("Move","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{await(async e=>{await s()({path:`/ai/v1/conversations/${e}/archive`,method:"POST"}),b(t=>t.filter(t=>t.id!==e)),N===e&&k(0)})(O),I(null)}},(0,o.__)("Archive","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{await(async e=>{await s()({path:`/ai/v1/conversations/${e}`,method:"DELETE"}),b(t=>t.filter(t=>t.id!==e)),N===e&&k(0)})(O),I(null)}},(0,o.__)("Delete","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>I(null)},(0,o.__)("Cancel","ai-gateway"))))),le&&(0,t.createElement)("div",{className:"ai-studio-modal"},(0,t.createElement)("div",{className:"ai-studio-modal-card"},(0,t.createElement)("h3",null,(0,o.__)("Project actions","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Rename","ai-gateway")),(0,t.createElement)("input",{value:ce,onChange:e=>de(e.target.value)})),(0,t.createElement)("div",{className:"ai-studio-modal-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{await s()({path:`/ai/v1/projects/${E}`,method:"PUT",data:{name:ce}}),_(e=>e.map(e=>e.id===E?{...e,name:ce}:e)),re(!1)}},(0,o.__)("Rename","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{await s()({path:`/ai/v1/projects/${E}`,method:"DELETE"}),_(e=>e.filter(e=>e.id!==E)),h(0),re(!1)}},(0,o.__)("Delete","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>re(!1)},(0,o.__)("Cancel","ai-gateway"))))),P&&(0,t.createElement)("div",{className:"ai-studio-modal"},(0,t.createElement)("div",{className:"ai-studio-modal-card large"},(0,t.createElement)("div",{className:"ai-studio-modal-header"},(0,t.createElement)("h3",null,(0,o.__)("Settings","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-icon-button",onClick:()=>x(!1)},"X")),(0,t.createElement)("iframe",{title:"Settings",className:"ai-studio-iframe",src:`${Ve}admin.php?page=ai-gateway-settings&studio=1`}))))}(0,a.registerBlockType)("ai-gateway/studio",{title:(0,o.__)("AI Studio","ai-gateway"),icon:"format-chat",category:"widgets",edit(){const e=(0,i.useBlockProps)({className:"ai-studio-block-placeholder"});return(0,t.createElement)("div",{...e},(0,o.__)("AI Studio App","ai-gateway"))},save(){const e=i.useBlockProps.save({className:"ai-studio-app"});return(0,t.createElement)("div",{...e})}});const u=()=>{const e=document.querySelectorAll(".ai-studio-app");e.length&&e.forEach(e=>{window.wp.element.render((0,t.createElement)(m,null),e)})};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u):u()})();