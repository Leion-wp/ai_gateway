(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var s in a)e.o(a,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:a[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.blocks,s=window.wp.blockEditor,i=window.wp.apiFetch;var n=e.n(i);const o=window.wp.i18n,l=window.wp.element,c=window.AIGatewaySettings||{restUrl:"",nonce:"",agents:[]};function r(){const[e,a]=(0,l.useState)(c.agents||[]),[s,i]=(0,l.useState)(c.studioDefaultAgent||c.agents?.[0]?.id||0),[r,d]=(0,l.useState)(""),[m,u]=(0,l.useState)({}),[p,y]=(0,l.useState)([]),[g,v]=(0,l.useState)([]),[E,w]=(0,l.useState)(0),[h,_]=(0,l.useState)([]),[b,N]=(0,l.useState)(0),[f,k]=(0,l.useState)(!1),[S,C]=(0,l.useState)(""),[A,T]=(0,l.useState)(!1),[j,O]=(0,l.useState)("empty"),[P,$]=(0,l.useState)(null),[x,U]=(0,l.useState)(0),[D,F]=(0,l.useState)(""),[G,M]=(0,l.useState)(!1),B=async(e,t,a)=>{if(e)try{await n()({path:`/ai/v1/conversations/${e}/messages`,method:"POST",data:{role:t,content:a}})}catch(e){C(e.message||"Failed to save message.")}},R=(0,l.useMemo)(()=>e.find(e=>e.id===s),[e,s]),q=(e=>(e||[]).map(e=>"string"==typeof e?{key:e,label:e,type:"text"}:e&&e.key?{key:e.key,label:e.label||e.key,type:e.type||"text",options:e.options||[],placeholder:e.placeholder||"",required:Boolean(e.required),env:e.env||""}:null).filter(Boolean))(R?.input_schema||[]).filter(e=>!e.env),I=c.adminUrl||"/wp-admin/",L=()=>{const e={};q.forEach(t=>{e[t.key]=""}),u(e)};(0,l.useEffect)(()=>{if(e.length)return;let t=!0;return(async()=>{try{const e=await n()({path:"/ai/v1/agents?enabled=1",method:"GET"});if(!t)return;const s=Array.isArray(e)?e:[];a(s);const o=c.studioDefaultAgent||0,l=s.find(e=>e.id===o);i(l?.id||s[0]?.id||0)}catch(e){t&&C(e.message||"Failed to load agents.")}})(),()=>{t=!1}},[e.length]),(0,l.useEffect)(()=>{L()},[s]),(0,l.useEffect)(()=>{let e=!0;return(async()=>{try{const t=await n()({path:"/ai/v1/projects",method:"GET"}),a=Array.isArray(t)?t:[];if(!e)return;if(!a.length){const e=await n()({path:"/ai/v1/projects",method:"POST",data:{name:"General"}});return v([e]),void w(e.id)}v(a),w(a[0]?.id||0)}catch(t){e&&C(t.message||"Failed to load projects.")}})(),()=>{e=!1}},[]),(0,l.useEffect)(()=>{if(!E)return;let e=!0;return(async()=>{try{const t=await n()({path:`/ai/v1/conversations?project_id=${E}`,method:"GET"});if(!e)return;const a=Array.isArray(t)?t:[];_(a),N(a[0]?.id||0)}catch(t){e&&C(t.message||"Failed to load conversations.")}})(),()=>{e=!1}},[E]),(0,l.useEffect)(()=>{if(!b)return void y([]);let e=!0;return(async()=>{try{const t=await n()({path:`/ai/v1/conversations/${b}`,method:"GET"});e&&t?.messages&&y(t.messages)}catch(t){e&&C(t.message||"Failed to load conversation.")}})(),()=>{e=!1}},[b]);const W=(e,t)=>{y(a=>{if(!a.length)return a;const s=[...a],i=s[s.length-1];return"assistant"!==i.role?a:(s[s.length-1]={...i,content:t?e:i.content+e},s)})};return(0,t.createElement)("div",{className:"ai-studio-app"},(0,t.createElement)("aside",{className:"ai-studio-sidebar"},(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Projects","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:E,onChange:e=>w(Number(e.target.value))},g.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Conversations","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-conversation-list"},h.map(e=>(0,t.createElement)("div",{key:e.id,className:"ai-studio-conversation-row"},(0,t.createElement)("button",{type:"button",className:"ai-studio-conversation "+(e.id===b?"active":""),onClick:()=>N(e.id)},(0,t.createElement)("div",{className:"ai-studio-conversation-title"},e.name),e.last&&(0,t.createElement)("div",{className:"ai-studio-conversation-last"},e.last)),(0,t.createElement)("button",{type:"button",className:"ai-studio-icon-button",onClick:()=>{$(e.id),U(0),F("")}},"⋯")))),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:async()=>{const e=await n()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});_(t=>[e,...t]),N(e.id)}},(0,o.__)("New chat","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Agents","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:s,onChange:e=>i(Number(e.target.value))},e.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Tools","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},(0,o.__)("Assigned via agent.","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Settings","ai-gateway")),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:()=>T(!0)},(0,o.__)("Open settings","ai-gateway")),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:()=>O("agents")},(0,o.__)("Agents editor","ai-gateway")))),(0,t.createElement)("main",{className:"ai-studio-main"},(0,t.createElement)("div",{className:"ai-studio-topbar"},(0,t.createElement)("div",{className:"ai-studio-topbar-left"},(0,t.createElement)("span",{className:"ai-studio-topbar-label"},(0,o.__)("Active agent","ai-gateway")),(0,t.createElement)("span",{className:"ai-studio-topbar-value"},R?.name||(0,o.__)("None","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-topbar-right"},(0,t.createElement)("span",{className:"ai-studio-status-dot"}),(0,t.createElement)("span",null,(0,o.__)("Ollama: online","ai-gateway")))),(0,t.createElement)("div",{className:"ai-studio-chat"},p.map((e,a)=>(0,t.createElement)("div",{key:a,className:`ai-studio-message ai-studio-${e.role}`},(0,t.createElement)("div",{className:"ai-studio-message-role"},e.role),(0,t.createElement)("div",{className:"ai-studio-message-content"},e.content)))),q.length>0&&(0,t.createElement)("div",{className:"ai-studio-inputs"},q.map(e=>(0,t.createElement)("label",{key:e.key,className:"ai-studio-field"},(0,t.createElement)("span",null,e.label),(0,t.createElement)("input",{type:"number"===e.type?"number":"url"===e.type?"url":"text",value:m[e.key]||"",placeholder:e.placeholder,onChange:t=>u(a=>({...a,[e.key]:t.target.value}))})))),(0,t.createElement)("div",{className:"ai-studio-composer"},S&&(0,t.createElement)("div",{className:"ai-studio-error"},S),(0,t.createElement)("div",{className:"ai-studio-composer-row"},(0,t.createElement)("button",{className:"ai-studio-button icon",type:"button",title:(0,o.__)("Add","ai-gateway"),onClick:()=>M(e=>!e)},"+"),G&&(0,t.createElement)("div",{className:"ai-studio-plus-menu"},(0,t.createElement)("button",{type:"button",onClick:()=>{M(!1),O("tools")}},(0,o.__)("Tools","ai-gateway")),(0,t.createElement)("button",{type:"button",onClick:()=>{M(!1),O("upload")}},(0,o.__)("Upload image","ai-gateway")),(0,t.createElement)("button",{type:"button",onClick:()=>{M(!1),O("chain")}},(0,o.__)("Chain agents","ai-gateway"))),(0,t.createElement)("textarea",{className:"ai-studio-textarea",rows:"3",placeholder:(0,o.__)("Ask something...","ai-gateway"),value:r,onChange:e=>d(e.target.value)}),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{if(!s)return void C("No agent selected.");k(!0),C("");let e=b;if(!e){const t=await n()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:E}});e=t.id,_(e=>[t,...e]),N(t.id)}const t={role:"user",content:r};y(e=>[...e,t,{role:"assistant",content:""}]),B(e,"user",r);try{const t=`${c.restUrl?c.restUrl.replace(/\/$/,""):"/wp-json/ai/v1"}/run/stream`,a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":c.nonce||""},body:JSON.stringify({agent_id:s,instruction:r,inputs:m})}),i=a.headers.get("content-type")||"";if(!a.ok||!a.body||!i.includes("text/event-stream"))throw new Error("Stream unavailable");const n=a.body.getReader(),o=new TextDecoder("utf-8");let l="";for(;;){const{value:t,done:a}=await n.read();if(a)break;l+=o.decode(t,{stream:!0});const s=l.split("\n\n");l=s.pop()||"",s.forEach(t=>{t.split("\n").forEach(t=>{if(!t.startsWith("data: "))return;const a=t.slice(6).trim();if(a)try{const t=JSON.parse(a);if(t.error)return void C(t.error);t.delta&&W(t.delta,!1),t.done&&t.full&&(W(t.full,!0),B(e,"assistant",t.full))}catch(e){C(e.message||"Stream parse error.")}})})}}catch(t){try{const t=await n()({path:"/ai/v1/run",method:"POST",data:{agent_id:s,instruction:r,inputs:m}});if(t?.error)C(t.error);else{const a=t?.mcp_response||t?.ollama_response||"";W(a,!0),B(e,"assistant",a)}}catch(e){C(e.message||t.message||"Stream failed.")}}finally{k(!1),d("")}},disabled:f},f?(0,o.__)("Running...","ai-gateway"):(0,o.__)("Send","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:L},(0,o.__)("Reset","ai-gateway"))))),(0,t.createElement)("aside",{className:"ai-studio-workspace"},"agents"===j?(0,t.createElement)("iframe",{title:"Agents",className:"ai-studio-iframe",src:`${I}admin.php?page=ai-gateway-agents&action=edit&agent_id=${s}&studio=1`}):"tools"===j?(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("Tools panel (coming soon)","ai-gateway")):"upload"===j?(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("Upload panel (coming soon)","ai-gateway")):"chain"===j?(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("Agent chain (coming soon)","ai-gateway")):(0,t.createElement)("div",{className:"ai-studio-workspace-empty"},(0,o.__)("Workspace","ai-gateway"))),P&&(0,t.createElement)("div",{className:"ai-studio-modal"},(0,t.createElement)("div",{className:"ai-studio-modal-card"},(0,t.createElement)("h3",null,(0,o.__)("Conversation actions","ai-gateway")),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Move to project","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:x,onChange:e=>U(Number(e.target.value))},(0,t.createElement)("option",{value:"0"},(0,o.__)("Select project","ai-gateway")),g.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("label",{className:"ai-studio-field"},(0,t.createElement)("span",null,(0,o.__)("Or create project","ai-gateway")),(0,t.createElement)("input",{value:D,onChange:e=>F(e.target.value),placeholder:(0,o.__)("New project name","ai-gateway")})),(0,t.createElement)("div",{className:"ai-studio-modal-actions"},(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{await(async e=>{let t=x;if(!t&&""!==D.trim()){const e=await n()({path:"/ai/v1/projects",method:"POST",data:{name:D.trim()}});v(t=>[e,...t]),t=e.id}t&&(await n()({path:`/ai/v1/conversations/${e}`,method:"PUT",data:{project_id:t}}),_(t=>t.filter(t=>t.id!==e)),b===e&&N(0))})(P),$(null)}},(0,o.__)("Move","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:async()=>{await(async e=>{await n()({path:`/ai/v1/conversations/${e}/archive`,method:"POST"}),_(t=>t.filter(t=>t.id!==e)),b===e&&N(0)})(P),$(null)}},(0,o.__)("Archive","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{await(async e=>{await n()({path:`/ai/v1/conversations/${e}`,method:"DELETE"}),_(t=>t.filter(t=>t.id!==e)),b===e&&N(0)})(P),$(null)}},(0,o.__)("Delete","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:()=>$(null)},(0,o.__)("Cancel","ai-gateway"))))),A&&(0,t.createElement)("div",{className:"ai-studio-modal"},(0,t.createElement)("div",{className:"ai-studio-modal-card large"},(0,t.createElement)("div",{className:"ai-studio-modal-header"},(0,t.createElement)("h3",null,(0,o.__)("Settings","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-icon-button",onClick:()=>T(!1)},"✕")),(0,t.createElement)("iframe",{title:"Settings",className:"ai-studio-iframe",src:`${I}admin.php?page=ai-gateway-settings&studio=1`}))))}c.nonce&&n().use(n().createNonceMiddleware(c.nonce)),(0,a.registerBlockType)("ai-gateway/studio",{title:(0,o.__)("AI Studio","ai-gateway"),icon:"format-chat",category:"widgets",edit(){const e=(0,s.useBlockProps)({className:"ai-studio-block-placeholder"});return(0,t.createElement)("div",{...e},(0,o.__)("AI Studio App","ai-gateway"))},save(){const e=s.useBlockProps.save({className:"ai-studio-app"});return(0,t.createElement)("div",{...e})}});const d=()=>{const e=document.querySelectorAll(".ai-studio-app");e.length&&e.forEach(e=>{window.wp.element.render((0,t.createElement)(r,null),e)})};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",d):d()})();