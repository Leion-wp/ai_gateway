(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var s in a)e.o(a,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:a[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.blocks,s=window.wp.blockEditor,i=window.wp.apiFetch;var n=e.n(i);const o=window.wp.i18n,r=window.wp.element,c=window.AIGatewaySettings||{restUrl:"",nonce:"",agents:[]};function l(){const[e,a]=(0,r.useState)(c.agents||[]),[s,i]=(0,r.useState)(c.studioDefaultAgent||c.agents?.[0]?.id||0),[l,d]=(0,r.useState)(""),[u,m]=(0,r.useState)({}),[p,v]=(0,r.useState)([]),[y,g]=(0,r.useState)([]),[h,w]=(0,r.useState)(0),[E,f]=(0,r.useState)([]),[b,N]=(0,r.useState)(0),[_,k]=(0,r.useState)(!1),[S,A]=(0,r.useState)(""),C=async(e,t,a)=>{if(e)try{await n()({path:`/ai/v1/conversations/${e}/messages`,method:"POST",data:{role:t,content:a}})}catch(e){A(e.message||"Failed to save message.")}},T=(0,r.useMemo)(()=>e.find(e=>e.id===s),[e,s]),j=(e=>(e||[]).map(e=>"string"==typeof e?{key:e,label:e,type:"text"}:e&&e.key?{key:e.key,label:e.label||e.key,type:e.type||"text",options:e.options||[],placeholder:e.placeholder||"",required:Boolean(e.required),env:e.env||""}:null).filter(Boolean))(T?.input_schema||[]).filter(e=>!e.env),O=()=>{const e={};j.forEach(t=>{e[t.key]=""}),m(e)};(0,r.useEffect)(()=>{if(e.length)return;let t=!0;return(async()=>{try{const e=await n()({path:"/ai/v1/agents?enabled=1",method:"GET"});if(!t)return;const s=Array.isArray(e)?e:[];a(s);const o=c.studioDefaultAgent||0,r=s.find(e=>e.id===o);i(r?.id||s[0]?.id||0)}catch(e){t&&A(e.message||"Failed to load agents.")}})(),()=>{t=!1}},[e.length]),(0,r.useEffect)(()=>{O()},[s]),(0,r.useEffect)(()=>{let e=!0;return(async()=>{try{const t=await n()({path:"/ai/v1/projects",method:"GET"}),a=Array.isArray(t)?t:[];if(!e)return;if(!a.length){const e=await n()({path:"/ai/v1/projects",method:"POST",data:{name:"General"}});return g([e]),void w(e.id)}g(a),w(a[0]?.id||0)}catch(t){e&&A(t.message||"Failed to load projects.")}})(),()=>{e=!1}},[]),(0,r.useEffect)(()=>{if(!h)return;let e=!0;return(async()=>{try{const t=await n()({path:`/ai/v1/conversations?project_id=${h}`,method:"GET"});if(!e)return;const a=Array.isArray(t)?t:[];f(a),N(a[0]?.id||0)}catch(t){e&&A(t.message||"Failed to load conversations.")}})(),()=>{e=!1}},[h]),(0,r.useEffect)(()=>{if(!b)return void v([]);let e=!0;return(async()=>{try{const t=await n()({path:`/ai/v1/conversations/${b}`,method:"GET"});e&&t?.messages&&v(t.messages)}catch(t){e&&A(t.message||"Failed to load conversation.")}})(),()=>{e=!1}},[b]);const P=(e,t)=>{v(a=>{if(!a.length)return a;const s=[...a],i=s[s.length-1];return"assistant"!==i.role?a:(s[s.length-1]={...i,content:t?e:i.content+e},s)})};return(0,t.createElement)("div",{className:"ai-studio-app"},(0,t.createElement)("aside",{className:"ai-studio-sidebar"},(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Projects","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:h,onChange:e=>w(Number(e.target.value))},y.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Conversations","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-conversation-list"},E.map(e=>(0,t.createElement)("button",{key:e.id,type:"button",className:"ai-studio-conversation "+(e.id===b?"active":""),onClick:()=>N(e.id)},(0,t.createElement)("div",{className:"ai-studio-conversation-title"},e.name),e.last&&(0,t.createElement)("div",{className:"ai-studio-conversation-last"},e.last)))),(0,t.createElement)("button",{type:"button",className:"ai-studio-button secondary",onClick:async()=>{const e=await n()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:h}});f(t=>[e,...t]),N(e.id)}},(0,o.__)("New chat","ai-gateway"))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Agents","ai-gateway")),(0,t.createElement)("select",{className:"ai-studio-select",value:s,onChange:e=>i(Number(e.target.value))},e.map(e=>(0,t.createElement)("option",{key:e.id,value:e.id},e.name)))),(0,t.createElement)("div",{className:"ai-studio-sidebar-section"},(0,t.createElement)("div",{className:"ai-studio-sidebar-title"},(0,o.__)("Tools","ai-gateway")),(0,t.createElement)("div",{className:"ai-studio-sidebar-empty"},(0,o.__)("Assigned via agent.","ai-gateway")))),(0,t.createElement)("main",{className:"ai-studio-main"},(0,t.createElement)("div",{className:"ai-studio-chat"},p.map((e,a)=>(0,t.createElement)("div",{key:a,className:`ai-studio-message ai-studio-${e.role}`},(0,t.createElement)("div",{className:"ai-studio-message-role"},e.role),(0,t.createElement)("div",{className:"ai-studio-message-content"},e.content)))),j.length>0&&(0,t.createElement)("div",{className:"ai-studio-inputs"},j.map(e=>(0,t.createElement)("label",{key:e.key,className:"ai-studio-field"},(0,t.createElement)("span",null,e.label),(0,t.createElement)("input",{type:"number"===e.type?"number":"url"===e.type?"url":"text",value:u[e.key]||"",placeholder:e.placeholder,onChange:t=>m(a=>({...a,[e.key]:t.target.value}))})))),(0,t.createElement)("div",{className:"ai-studio-composer"},S&&(0,t.createElement)("div",{className:"ai-studio-error"},S),(0,t.createElement)("textarea",{className:"ai-studio-textarea",rows:"3",placeholder:(0,o.__)("Ask something...","ai-gateway"),value:l,onChange:e=>d(e.target.value)}),(0,t.createElement)("div",{className:"ai-studio-actions"},(0,t.createElement)("button",{className:"ai-studio-button",onClick:async()=>{if(!s)return void A("No agent selected.");k(!0),A("");let e=b;if(!e){const t=await n()({path:"/ai/v1/conversations",method:"POST",data:{name:"Conversation",project_id:h}});e=t.id,f(e=>[t,...e]),N(t.id)}const t={role:"user",content:l};v(e=>[...e,t,{role:"assistant",content:""}]),C(e,"user",l);try{const t=await fetch("/wp-json/ai/v1/run/stream",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":c.nonce||""},body:JSON.stringify({agent_id:s,instruction:l,inputs:u})}),a=t.headers.get("content-type")||"";if(!t.ok||!t.body||!a.includes("text/event-stream"))throw new Error("Stream unavailable");const i=t.body.getReader(),n=new TextDecoder("utf-8");let o="";for(;;){const{value:t,done:a}=await i.read();if(a)break;o+=n.decode(t,{stream:!0});const s=o.split("\n\n");o=s.pop()||"",s.forEach(t=>{t.split("\n").forEach(t=>{if(!t.startsWith("data: "))return;const a=t.slice(6).trim();if(a)try{const t=JSON.parse(a);if(t.error)return void A(t.error);t.delta&&P(t.delta,!1),t.done&&t.full&&(P(t.full,!0),C(e,"assistant",t.full))}catch(e){A(e.message||"Stream parse error.")}})})}}catch(e){A(e.message||"Stream failed.")}finally{k(!1),d("")}},disabled:_},_?(0,o.__)("Running...","ai-gateway"):(0,o.__)("Send","ai-gateway")),(0,t.createElement)("button",{className:"ai-studio-button secondary",onClick:O},(0,o.__)("Reset","ai-gateway"))))))}c.nonce&&n().use(n().createNonceMiddleware(c.nonce)),(0,a.registerBlockType)("ai-gateway/studio",{title:(0,o.__)("AI Studio","ai-gateway"),icon:"format-chat",category:"widgets",edit(){const e=(0,s.useBlockProps)({className:"ai-studio-block-placeholder"});return(0,t.createElement)("div",{...e},(0,o.__)("AI Studio App","ai-gateway"))},save(){const e=s.useBlockProps.save({className:"ai-studio-app"});return(0,t.createElement)("div",{...e})}});const d=()=>{const e=document.querySelectorAll(".ai-studio-app");e.length&&e.forEach(e=>{window.wp.element.render((0,t.createElement)(l,null),e)})};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",d):d()})();